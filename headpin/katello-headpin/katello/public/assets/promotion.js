var promotion_page=(function(s){var y=["errata","product","package","repo","template","distribution"],u=["errata","package","repo","distribution"],a=[],F={},v,G,w,i,l=function(){v=setInterval(I,1000)},E=function(){clearInterval(v);v=undefined},A=function(){if(s("#depend_size").length){s.ajax({type:"GET",url:s("#depend_size").attr("data-url"),cache:false,success:function(K){s("#depend_size").html(K)}})}},g=function(){return a.length===0&&v!==undefined},t=function(L,K){return s("a[class~=content_add_remove][data-id="+KT.common.escapeId(L)+"][data-type="+K+"]")},p=function(){var L=[],N=[],O={};var M=function(Q){O[Q]={name:Q};s.each(u,function(R,S){O[Q][S+"_add"]=[];O[Q][S+"_remove"]=[]})};var P=[],K=[];return{templates_added:P,templates_removed:K,products_added:L,products_removed:N,products:O,size:function(){var Q=0;Q+=L.length+N.length+P.length+K.length;s.each(O,function(S,R){s.each(u,function(T,U){Q+=R[U+"_add"].length+R[U+"_remove"].length})});return Q},add_item:function(S,Q,R,V){var U=R?"add":"remove";if(S==="product"){var T=R?L:N;T.push(Q)}else{if(S=="template"){var W=R?P:K;W.push(Q)}else{if(O[V]===undefined){M(V)}O[V][S+"_"+U].push(Q)}}}}},d=function(O,K){var N=p(),R={},P={},S={},M={},Q={},L={};s.each(K.getProducts(),function(T,U){P[U.id]=U;S[U.id]=U});s.each(O.getProducts(),function(T,U){R[U.id]=U;S[U.id]=U});s.each(S,function(W,U){var V=R[W];var T=P[W];if(T&&T.all&&(!V||!V.all)){N.add_item("product",U.name,true)}else{if(V&&V.all&&(!T||!T.all)){N.add_item("product",U.name,false)}}s.each(u,function(X,Y){var ab=[];if(T){ab=T[Y]}var Z=[];if(V){Z=V[Y]}var aa=ab.concat(Z);s.each(aa,function(ac,ae){var ad=K.has_item(Y,ae.id,U.id);var af=O.has_item(Y,ae.id,U.id);if(ad&&!af){N.add_item(Y,ae.name,true,U.name)}else{if(!ad&&af){N.add_item(Y,ae.name,false,U.name)}}})})});s.each(K.getTemplates(),function(T,U){Q[U.id]=U;L[U.id]=U});s.each(O.getTemplates(),function(T,U){M[U.id]=U;L[U.id]=U});s.each(L,function(W,U){var T=M[W];var V=Q[W];if(V&&!T){N.add_item("template",U.name,true)}else{if(T&&!V){N.add_item("template",U.name,false)}}});return N},C=function(K){s("#conflict-dialog").dialog({modal:true,width:400});s("#conflict-accordion").html(promotionsRenderer.renderConflict(K))},D=function(){var K=s("#conflict-accordion");K.show();K.accordion({fillSpace:true,beforeClose:e})},e=function(){s("#conflict-dialog").dialog("close");var K=s("#conflict-accordion");K.accordion("destroy");K.html("");K.hide()},I=function(){if(a.length>0&&G){E();var K=[];while(a.length>0){K.push(a.shift())}G.update(K,function(M){if(a.length===0||!M.changeset){if(M.changeset){var L=G;G=changeset_obj(M.changeset);H();i.rerender_content();var N=d(L,G);if(N.size()>0){C(N)}}else{G.set_timestamp(M.timestamp)}}l()},k)}},f=function(K,L){s("#wait_dialog").dialog({closeOnEscape:false,modal:true,open:function(M,N){s(".ui-dialog-titlebar-close").hide()}});if(!K()){setTimeout(function(){f(K,L)},250)}else{s("#wait_dialog").dialog("close");L()}},k=function(){s("#error_dialog").dialog({closeOnEscape:false,modal:true,open:function(K,L){s(".ui-dialog-titlebar-close").hide()}})},z=function(L,P,Q,N){var S=G;var K=true;if(S&&S.has_item(Q,L,N)){K=false}var O=t(L,Q);var M="";if(N){M=content_breadcrumb["details_"+N].name}if(K){O.html(i18n.remove).addClass("remove_"+Q).removeClass("add_"+Q);if(Q!=="product"){if(Q==="template"){if(S.getTemplates()[L]===undefined){n(S.id,L,P)}}else{if(S.getProducts()[N]===undefined){q(S.id,N,M)}}}S.add_item(Q,L,P,N,M);i.rerender_content()}else{O.html(i18n.add).addClass("add_"+Q).removeClass("remove_"+Q);S.remove_item(Q,L,N);if(Q!=="product"){if(Q==="template"){delete S.getTemplates()[L];i.rerender_content()}else{var R=S.getProducts()[N];if(!R.errata.length&&!R["package"].length&&!R.repo.length&&!R.distribution.length){delete S.getProducts()[N];i.render_content("changeset_"+S.id)}else{i.rerender_content()}}}else{i.rerender_content()}}r();B();a.push([Q,L,P,K,N])},r=function(){s(".right_tree .will_have_content").find("li").each(function(K,L){s(L).find("li").sortElements(function(N,M){var P=s(N).find(".sort_attr").html();var O=s(M).find(".sort_attr").html();if(P&&O){return P.toUpperCase()>O.toUpperCase()?1:-1}})})},o=function(){var L,K;r();if(!G){for(K in changeset_breadcrumb){if(changeset_breadcrumb.hasOwnProperty(K)){if(K.split("_")[0]==="changeset"){L=changeset_breadcrumb[K];if(L.state==="failed"){changesetStatusActions.initProgressBar(K,L.progress,i18n.promotion_failed)}else{if(!L.is_new&&(L.progress===null||L.progress===undefined)){changesetStatusActions.setLocked(K)}else{if(L.progress!==null&&L.progress!==undefined){changesetStatusActions.initProgressBar(K,L.progress);changesetStatusActions.checkProgressTask(K.split("_")[1])}}}}}}}},h=function(K,M){var L=M.attr("data-url");window.location=L},J=function(L,K){s("#tree_loading").css("z-index",300);s.ajax({type:"GET",url:KT.common.rootURL()+"changesets/"+L+"/object/",cache:false,success:function(M){s("#tree_loading").css("z-index",-1);G=changeset_obj(M);H();K()}})},c=function(K){var L=K.split("_");if(L.length>1){w=L[L.length-1]}else{w=undefined}H()},B=function(){if(G===undefined){s("#changeset_status").html("")}else{var M=[];var L=0;s.each(G.getProducts(),function(N,O){if(O.all){L+=1}});M.push(["product",L]);s.each(u,function(N,P){var O=0;s.each(G.getProducts(),function(Q,R){O+=R[P].length});M.push([P,O])});var K=[];s.each(M,function(N,O){if(O[1]===1){K.push(O[1]+" "+i18n[O[0]+"_singular"])}else{if(O[1]>1){K.push(O[1]+" "+i18n[O[0]+"_plural"])}}});if(K.length===0){s("#changeset_status").html(i18n.summary+" "+i18n.changeset_empty)}else{s("#changeset_status").html(i18n.summary+" "+K.join(", "))}}},H=function(){if(G&&permissions.manage_changesets){if(w){var N=G.getProducts()[w];if(N!==undefined&&N.all!==undefined){x(u)}else{s.each(u,function(O,P){var Q=s("#list").find("a[class~=content_add_remove][data-type="+P+"]");Q.html(i18n.add).removeClass("remove_"+P).addClass("add_"+P).show();if(N){s.each(N[P],function(R,S){s("a[class~=content_add_remove][data-type="+P+"][data-id="+S.id+"]").html(i18n.remove).removeClass("add_"+P).addClass("remove_"+P)})}})}}else{var M=s("#list").find("a[class~=content_add_remove][data-type=product]");M.html(i18n.add).removeClass("remove_product").addClass("add_product").show();s.each(G.getProducts(),function(O,P){s.each(M,function(R,Q){if(s(Q).attr("id")===("add_remove_product_"+P.id)){if(P.all===true){s(Q).html(i18n.remove).removeClass("add_product").addClass("remove_product").removeClass("disabled")}else{s(Q).html("")}}})});M=s("#list").find("a[class~=content_add_remove][data-type=template]");M.html(i18n.add).removeClass("remove_template").addClass("add_template").show();s.each(G.getTemplates(),function(O,P){s.each(M,function(R,Q){if(s(Q).attr("id")===("add_remove_template_"+P.id)){s(Q).html(i18n.remove).removeClass("add_template").addClass("remove_template").removeClass("disabled")}})})}}else{x(y)}var L=s("#review_cancel");var K=s("#changeset_status");if(G){K.show();s("#sliding_tree_actionbar > div").removeClass("disabled");if(!permissions.manage_changesets){s("#edit_changeset").addClass("disabled");s("#delete_changeset").addClass("disabled");s("#review_changeset").addClass("disabled")}if(G.is_new()||G.state()==="failed"){L.hide();s("#changeset_tree .tree_breadcrumb").removeClass("locked_breadcrumb");s(".breadcrumb_filter").removeClass("locked_breadcrumb_filter");s("#cslist").removeClass("locked");s("#locked_icon").remove();s("#review_changeset > span").html(i18n.review);s("#promote_changeset").addClass("disabled")}else{if(G.state()==="promoted"||G.state()==="promoting"){s("#changeset_tree .tree_breadcrumb").addClass("locked_breadcrumb");s(".breadcrumb_filter").addClass("locked_breadcrumb_filter");if(s("#locked_icon").length===0){s("#changeset_tree .tree_breadcrumb #changeset_"+G.id).prepend('<div id="locked_icon" class="locked_icon fl" >')}s("#cslist").addClass("locked");s(".content_add_remove").hide();s("#sliding_tree_actionbar > div").addClass("disabled")}else{L.show();s("#changeset_tree .tree_breadcrumb").addClass("locked_breadcrumb");s(".breadcrumb_filter").addClass("locked_breadcrumb_filter");if(s("#locked_icon").length===0){s("#changeset_tree .tree_breadcrumb #changeset_"+G.id).prepend('<div id="locked_icon" class="locked_icon fl" >')}s("#cslist").addClass("locked");s(".content_add_remove").hide();s("#review_changeset > span").html(i18n.cancel_review);if(permissions.promote_changesets){s("#promote_changeset").removeClass("disabled")}else{s("#promote_changeset").addClass("disabled")}}}}else{s(K.hide());s("#changeset_tree .tree_breadcrumb").removeClass("locked_breadcrumb");s(".breadcrumb_filter").removeClass("locked_breadcrumb_filter");s("#cslist").removeClass("locked");s("#locked_icon").remove();L.hide();changesetEdit.close();s("#sliding_tree_actionbar > div").addClass("disabled")}if(!permissions.manage_changesets){x(y)}B()},x=function(K){var L=K||u;s.each(L,function(M,N){var O=s("a[class~=content_add_remove][data-type="+N+"]");O.hide().html(i18n.add)})},b=function(L){if(L.length>0){var K=L.join(", ")+" "+i18n.viewing;s("#changeset_users").html(K).fadeIn()}else{s("#changeset_users").fadeOut("slow",function(){s(this).html("")})}},n=function(O,N,M){var L="changeset_"+O;var K="template-cs_"+O+"_"+N;changeset_breadcrumb[K]={cache:null,client_render:true,name:M,trail:["changesets",L],url:"url"}},q=function(O,M,N){var L="product-cs_"+O+"_"+M;var K="changeset_"+O;changeset_breadcrumb[L]={cache:null,client_render:true,name:N,trail:["changesets",K],url:"url"};changeset_breadcrumb["package-cs_"+O+"_"+M]={cache:null,client_render:true,name:"Packages",trail:["changesets",K,L],url:""};changeset_breadcrumb["errata-cs_"+O+"_"+M]={cache:null,client_render:true,name:"Errata",trail:["changesets",K,L],url:""};changeset_breadcrumb["repo-cs_"+O+"_"+M]={cache:null,client_render:true,name:"Repositories",trail:["changesets",K,L],url:""};changeset_breadcrumb["distribution-cs_"+O+"_"+M]={cache:null,client_render:true,name:"Distributions",trail:["changesets",K,L],url:""}},j=function(){if(G===undefined){return false}s.each(G.getProducts(),function(M,N){var O="deps-cs_"+G.id+"_"+M;if(changeset_breadcrumb[O]===undefined){var L="product-cs_"+G.id+"_"+M;var K="changeset_"+G.id;changeset_breadcrumb[O]={cache:null,client_render:true,name:"Dependencies",trail:["changesets",K,L],url:""}}});return true},m=function(){if(G===undefined){return false}s.each(changeset_breadcrumb,function(K,L){if(K.indexOf("deps-cs_")===0){delete changeset_breadcrumb[K]}});return true};return{subtypes:u,get_changeset_tree:function(){return i},set_changeset_tree:function(K){i=K},get_changeset:function(){return G},set_changeset:function(K){G=K},modify_changeset:z,sort_changeset:r,fetch_changeset:J,set_current_product:c,are_updates_complete:g,env_change:h,checkUsersInResponse:b,start_timer:l,reset_page:H,throw_error:k,wait:f,calc_conflict:d,hide_conflict:e,show_conflict_details:D,add_dependencies:j,remove_dependencies:m,init_changeset_list:o}}(jQuery));var changeset_obj=function(f){var e=f.id,h=f.timestamp,i=f.products,j=f.system_templates,a=f.is_new,c=f.state,l=false,b=f.name,k=f.description;var g=function(n,o,m){$.ajax({contentType:"application/json",type:"PUT",url:KT.common.rootURL()+"changesets/"+e,data:JSON.stringify({timestamp:h,state:n}),cache:false,success:function(p){h=p.timestamp;a=(n==="new");c=n;o()},error:function(p){if(p.changeset){promotion_page.set_changeset(changeset_obj(p.changeset))}else{promotion_page.throw_error()}}})},d=function(){$.ajax({type:"GET",url:KT.common.rootURL()+"changesets/"+e+"/dependencies",cache:false,success:function(m){$.each(m,function(n,o){i[n].deps=o});promotion_page.get_changeset_tree().rerender_content()}})};if(!a){d()}return{id:e,getName:function(){return b},setName:function(m){b=m;changeset_breadcrumb["changeset_"+e].name=m},getDescription:function(){return k},setDescription:function(m){k=m},getProducts:function(){return i},getTemplates:function(){return j},is_new:function(){return a},state:function(){return c},has_failed:function(){return l},set_timestamp:function(m){h=m},timestamp:function(){return h},productCount:function(){var n=0;for(var m in i){if(i.hasOwnProperty(m)){n+=1}}return n},has_item:function(n,p,m){var o=undefined;if(n==="template"){if(j.hasOwnProperty(p)){return true}}if(n==="product"){if(i.hasOwnProperty(p)){return true}}if(i.hasOwnProperty(m)){$.each(i[m][n],function(q,r){if(r.id===p){o=true;return false}})}return o!==undefined},add_item:function(o,q,m,n,p){if(o==="product"){i[q]={name:m,id:q,"package":[],errata:[],repo:[],distribution:[],all:true}}else{if(o==="template"){j[q]={name:m,id:q}}else{if(i[n]===undefined){i[n]={name:p,id:n,"package":[],errata:[],repo:[],distribution:[]}}i[n][o].push({name:m,id:q})}}},remove_item:function(n,o,m){if(n==="product"){delete i[o]}else{if(n=="template"){delete j[o]}else{if(i[m]!==undefined){$.each(i[m][n],function(p,q){if(q.id===o){i[m][n].splice(p,1);return false}})}}}},review:function(o,m){var n=function(){o();d()};g("review",n,m);changeset_breadcrumb["changeset_"+e].is_new=false;promotion_page.add_dependencies()},cancel_review:function(n,m){g("new",n,m);changeset_breadcrumb["changeset_"+e].is_new=true},promote:function(n,m){$.ajax({type:"POST",url:KT.common.rootURL()+"changesets/"+e+"/promote",cache:false,success:function(o){if(n){n()}changeset_breadcrumb["changeset_"+e].is_new=true;changeset_breadcrumb["changeset_"+e].state="new";changeset_breadcrumb["changeset_"+e].progress=0;promotion_page.get_changeset_tree().render_content("changesets")},error:function(){if(m){m()}}})},update:function(n,p,m){var o=[];$.each(n,function(q,s){var r={};r.type=s[0];r.item_id=s[1];r.item_name=s[2];r.adding=s[3];if(s[4]){r.product_id=s[4]}o.push(r)});$.ajax({contentType:"application/json",type:"PUT",url:KT.common.rootURL()+"changesets/"+e,data:JSON.stringify({data:o,timestamp:h}),cache:false,success:p,error:m})}}};var registerEvents=function(){$("#save_changeset_button").live("click",function(){var a=$(this);if(a.hasClass("disabled")){return false}a.addClass("disabled");$.ajax({type:"POST",url:a.attr("data-url"),data:$("#new_changeset").serialize(),cache:false,success:function(b){$.extend(changeset_breadcrumb,b.breadcrumb);promotion_page.set_changeset(changeset_obj(b.changeset));promotion_page.get_changeset_tree().render_content("changeset_"+b.id);KT.panel.closePanel($("#panel"))},error:function(){a.removeClass("disabled")}});return true});$("#delete_changeset").click(function(){var a=$(this);if(a.hasClass("disabled")){return false}var b=promotion_page.get_changeset().id;KT.common.customConfirm(a.attr("data-confirm-text"),function(){a.addClass("disabled");$.ajax({type:"DELETE",url:a.attr("data-url")+"/"+b,cache:false,success:function(c){delete changeset_breadcrumb["changeset_"+b];promotion_page.set_changeset("changesets");promotion_page.get_changeset_tree().render_content("changesets")}})});return true});$("#review_changeset").live("click",function(){var a=$(this);if(a.hasClass("disabled")){return false}a.addClass("disabled");var b=promotion_page.get_changeset();if(b.is_new()||b.state()==="failed"){var c=function(){b.review(function(){a.removeClass("disabled");promotion_page.reset_page();promotion_page.get_changeset_tree().rerender_content()})};if(!promotion_page.are_updates_complete()){promotion_page.wait(promotion_page.are_updates_complete,c)}else{c()}}else{b.cancel_review(function(){a.removeClass("disabled");promotion_page.reset_page();promotion_page.get_changeset_tree().rerender_content();promotion_page.remove_dependencies()})}return true});$("#promote_changeset").live("click",function(){if($(this).hasClass("disabled")){return false}$(this).addClass("disabled");$("#sliding_tree_actionbar > div").addClass("disabled");var a=promotion_page.get_changeset();var b=function(){$(this).removeClass("disabled")};a.promote(b,function(){});return true});window.onbeforeunload=function(){if(!promotion_page.are_updates_complete()){return i18n.leave_page}};$("#conflict_close").click(promotion_page.hide_conflict);$("#conflict-details").click(promotion_page.show_conflict_details);$("#edit_changeset").live("click",function(){if($(this).hasClass("disabled")){return false}changesetEdit.toggle();return true})};var changesetEdit=(function(){var d=false;var a=function(g){var h=$("#changeset_edit"),e=$(".edit_name_text"),f=$("#edit_changeset > span"),i=$(".edit_description"),l=promotion_page.get_changeset(),j=500;if(g!=undefined){j=g}d=!d;var k=undefined;if(d){e.html(l.getName());f.html(i18n.close_details);i.html(l.getDescription());f.parent().addClass("highlighted");k=b}else{f.html(i18n.edit_details);f.parent().removeClass("highlighted")}h.slideToggle(j,k)},b=function(){var h=promotion_page.get_changeset(),f=KT.common.rootURL()+"changesets/"+h.id,e=$(".edit_name_text"),g=$(".edit_description");e.each(function(){$(this).editable(f,{type:"text",width:270,method:"PUT",name:$(this).attr("name"),cancel:i18n.cancel,submit:i18n.save,indicator:i18n.saving,tooltip:i18n.clickToEdit,placeholder:i18n.clickToEdit,submitdata:{authenticity_token:AUTH_TOKEN},onsuccess:function(j){var i=$.parseJSON(j);h.setName(i.name);$(".edit_name_text").html(i.name);h.set_timestamp(i.timestamp);promotion_page.get_changeset_tree().rerender_breadcrumb()},onerror:function(j,i,k){i.reset()}})});g.each(function(){$(this).editable(f,{type:"textarea",method:"PUT",name:$(this).attr("name"),cancel:i18n.cancel,submit:i18n.save,indicator:i18n.saving,tooltip:i18n.clickToEdit,placeholder:i18n.clickToEdit,submitdata:{authenticity_token:AUTH_TOKEN},rows:5,cols:30,onsuccess:function(j){var i=$.parseJSON(j);$(".edit_description").html(i.description);h.setDescription(j.description);h.set_timestamp(i.timestamp)},onerror:function(j,i,k){i.reset()}})})},c=function(){if(d){a(0)}};return{toggle:function(){a()},close:c}})();var promotionsRenderer=(function(){var b=function(j,d){if(j==="changesets"){var h=function(){promotion_page.set_changeset(undefined);d(templateLibrary.changesetsList(changeset_breadcrumb))};if(!promotion_page.are_updates_complete()){promotion_page.wait(promotion_page.are_updates_complete,function(){h()})}else{h()}}else{var f=j.split("_"),i=f[0],k=f[1],e=f[2],g=promotion_page.get_changeset();if(i==="changeset"&&g!==undefined&&k!==g.id){promotion_page.set_changeset(undefined)}if(promotion_page.get_changeset()===undefined){promotion_page.fetch_changeset(k,function(){d(c(i,k,e))})}else{d(c(i,k,e))}}promotion_page.reset_page()},c=function(f,i,e){var h=promotion_page.get_changeset(),g=(!h.is_new()&&(h.state()!=="failed"));if(f==="package-cs"){return templateLibrary.listItems(h.getProducts(),"package",e,!g)}else{if(f==="errata-cs"){return templateLibrary.listItems(h.getProducts(),"errata",e,!g)}else{if(f==="repo-cs"){return templateLibrary.listItems(h.getProducts(),"repo",e,!g)}else{if(f==="distribution-cs"){return templateLibrary.listItems(h.getProducts(),"distribution",e,!g)}else{if(f==="deps-cs"){return templateLibrary.dependencyItems(h.getProducts(),e)}else{if(f==="product-cs"){var d=promotion_page.subtypes.slice(0);if(!promotion_page.get_changeset().is_new()){d.push("deps")}return templateLibrary.productDetailList(h.getProducts()[e],d,i)}else{if(f==="changeset"){return templateLibrary.productList(h,h.id,!g)}}}}}}}},a=function(e){var d=templateLibrary.conflictFullProducts(e.products_added,e.products_removed);$.each(e.products,function(f,g){d+=templateLibrary.conflictProduct(f,g)});d+=templateLibrary.conflictTemplates(e.templates_added,e.templates_removed);return d};return{render:b,renderConflict:a}})();var templateLibrary=(function(){var c=function(p,n){var o='<li class="slide_link"><div class="simple_link link_details" id="'+p+'">';o+='<span class="sort_attr">'+n+"</span></div></li>";return o},d=function(n){var o='<ul class="filterable">';for(item in n){if(n.hasOwnProperty(item)){if(item.split("_")[0]==="changeset"){o+=c(item,n[item].name)}}}o+="</ul>";return o},h=function(o,p,q){var n='<ul class="filterable">';$.each(p,function(r,s){if(o[s]){n+='<li class="slide_link"><div class="simple_link link_details"'}else{n+="<li><div "}n+="id="+s+"-cs_"+q+"_"+o.id+">";n+='<span class="sort_attr">'+i18n[s];if(o[s]){n+=" ("+o[s].length+")"}else{n+="<img class='fr' src='"+KT.common.spinner_path()+"'>"}n+="</span></li>"});n+="</ul>";return n},m=function(p,o){if(!p[o].deps){return i18n.loading_deps+"&nbsp;<img  src='"+KT.common.spinner_path()+"'>"}var n='<ul class="filterable">';$.each(p[o].deps,function(q,r){n+='<li><div class="no_slide"><span class="sort_attr">'+r.name+" </span>";n+="</div></li>"});n+="</ul>";return n},f=function(s,r,q,n){var p='<ul class="filterable">';var o=s[q][r];if(o.length===0){return i18n["no_"+r]}$.each(o,function(t,u){p+=a(u.id,u.name,r,q,n)});p+="</ul>";return p},a=function(s,p,r,q,n){var o="";if(n&&permissions.manage_changesets){o='<a class="fr content_add_remove remove_'+r+' + st_button"data-type="'+r+'" data-product_id="'+q+'" data-id="'+s+'">';o+=i18n.remove+"</a>"}return"<li>"+o+'<div class="no_slide"><span class="sort_attr">'+p+"</span></div></li>"},g=function(z,p,s){var u='<ul class="filterable">',n="</ul>",q=u,r="",o="",y="",x,v,t=z.getProducts(),w=z.getTemplates();if(z.productCount()===0){q+="<h5>"+i18n.product_plural+"</h5>";q+='<div class="empty_list">'+i18n.no_products+"</div>"}else{for(key in t){if(t.hasOwnProperty(key)){x=t[key];v=(x.provider==="REDHAT")?"rh":"custom";toSlide=x.all?"no_slide":"slide_link";if(x.all){r+=l(p,key,x.name,v,toSlide,s)}else{o+=l(p,key,x.name,v,toSlide,false)}}}}for(key in w){if(w.hasOwnProperty(key)){template=w[key];y+=k(p,key,template.name,s)}}q+=n+u;q+=r?("<h5>"+i18n.full_product+"</h5>"+r):"";q+=n+u;q+=o?("<h5>"+i18n.partial_product+"</h5>"+o):"";q+=n+u;q+="<h5>"+i18n.system_template_plural+"</h5>";q+=y?y:'<div class="empty_list">'+i18n.no_system_templates+"</div>";q+=n;return q},k=function(s,r,p,n){var o="",q="";if(n){o='<a class="st_button content_add_remove fr remove_template" data-display_name="'+p+'" data-id="'+r+'" data-type="template" id="add_remove_template_'+r+'" data-template_id="'+r+'">'+i18n.remove+"</a>"}q+='<li class="clear">'+o;q+='<div id="template-cs_'+s+"_"+r+'"><span class="template-icon sort_attr" >'+p+"</span></div></li>";return q},b=function(o,p){if(o.length===0&&p.length===0){return""}var n="<h3>"+i18n.templates+"</h3>";n+="<div>";n+=e(true,o);n+=e(false,p);n+="</div>";return n},l=function(u,s,q,t,p,n){var o="",r="";if(n){o='<a class="st_button content_add_remove fr remove_product" data-display_name="'+q+'" data-id="'+s+'" data-type="product" id="add_remove_product_'+s+'" data-product_id="'+s+'">'+i18n.remove+"</a>"}r+='<li class="clear '+p+'">'+o+'<div class="';r+=(p==="slide_link")?"link_details":"";r+='" id="product-cs_'+u+"_"+s+'"><span class="'+t+'-product-sprite"></span><span class="product-icon sort_attr" >'+q+"</span></div></li>";return r},j=function(o,p){if(o.length===0&&p.length===0){return""}var n="<h3>"+i18n.full_product+"</h3>";n+="<div>";n+=e(true,o);n+=e(false,p);n+="</div>";return n},i=function(o,p){var n='<h3><a href="#">'+o+"</a></h3>";n+="<div>";$.each(promotion_page.subtypes,function(q,s){var r=p[s+"_add"];var t=p[s+"_remove"];if(r.length>0||t.length>0){n+="<div>"+i18n[s]+":</div>";n+=e(true,r);n+=e(false,t)}});n+="</div>";return n},e=function(p,n){if(n.length===0){return""}var o='<div class="conflict_item_type"><div>'+(p?i18n.added:i18n.removed)+"</div>";o+="<ul>";$.each(n,function(q,r){o+="<li class='conflict_item'>"+r+"</li>"});o+="</ul></div>";return o};return{changesetsList:d,productList:g,listItems:f,productDetailList:h,conflictFullProducts:j,conflictTemplates:b,conflictProduct:i,dependencyItems:m}})();var changesetStatusActions=(function(e){var a=function(){if(e(".progressbar").length){e("#cslist .slider .link_details:not(:has(.progressbar)):not(:has(.locked_icon))").css("margin-left","43px");e("#cslist .slider .link_details:not(:has(.progressbar)) .locked_icon").css({"margin-left":"9px","margin-right":"22px"})}else{if(e("#cslist .locked_icon").length){e("#cslist .slider .link_details:not(:has(.progressbar)):not(:has(.locked_icon))").css("margin-left","20px")}}},i=function(n,k,l){var m=e("#"+n),j=l;if(l===undefined){l=i18n.promoting;j=i18n.changeset_progress}m.css("margin-left","0");m.prepend('<span class="changeset_status"><span class="progressbar"></span><label></label></span>');m.find(".changeset_status label").text(k+"%");m.addClass("being_promoted");m.attr("title",j);m.find(".changeset_status label").text(l);a()},d=function(l,j){var k=e("#"+l)},h=function(k){var j=e("#"+k);j.find(".changeset_status label").text(i18n.promoted);j.attr("title",i18n.promoted)},g=function(k){notices.checkNotices();var j=e("#"+k);j.find(".changeset_status label").text(i18n.promotion_failed);j.attr("title",i18n.promotion_failed);changeset_breadcrumb[k].has_failed=true},b=function(k){var j=e("#"+k);j.css("margin-left","0");j.prepend('<img class="fl locked_icon" src="'+KT.common.rootURL()+'/images/icons/locked.png">');a()},f=function(k){var j=e("#"+k);j.find("img").remove();j.css("margin-left","20px");if(!e("#cslist .locked_icon").length){e("#cslist .slider .link_details").css("margin-left","0")}},c=function(l){var j=8000;var k=e.PeriodicalUpdater(KT.common.rootURL()+"changesets/"+l+"/promotion_progress/",{method:"GET",type:"JSON",cache:false,global:false,minTimeout:j,maxTimeout:j},function(m,n){d(m.id,m.progress);if(n==="notmodified"){var o="changeset_"+l;if(changeset_breadcrumb[o].has_failed===true){g(o);k.stop()}}else{if((m.progress===100)||(m.state==="promoted")){delete changeset_breadcrumb["changeset_"+l];h(m.id);k.stop()}else{if(m.state==="failed"){g(m.id);k.stop()}}}})};return{initProgressBar:i,setProgress:d,finishProgess:h,checkProgressTask:c,setLocked:b,removeLocked:f}})(jQuery);$(document).ready(function(){$(".left").resizable("destroy");promotion_page.start_timer();$(".content_add_remove").live("click",function(){if(!$(this).hasClass("disabled")){var e=$(this).attr("data-environment_id");var g=$(this).attr("data-id");var f=$(this).attr("data-display_name");var d=$(this).attr("data-type");var c=$(this).attr("data-product_id");promotion_page.modify_changeset(g,f,d,c)}});$("#changeset_users").hide();var b=sliding_tree("content_tree",{breadcrumb:content_breadcrumb,default_tab:"content",bbq_tag:"content",base_icon:"home_img",tab_change_cb:promotion_page.set_current_product});b.enableSearch();promotion_page.set_changeset_tree(sliding_tree("changeset_tree",{breadcrumb:changeset_breadcrumb,default_tab:"changesets",bbq_tag:"changeset",base_icon:"home_img",render_cb:promotionsRenderer.render,enable_filter:true,enable_float:true,tab_change_cb:function(c){promotion_page.init_changeset_list()}}));KT.panel.list.set_extended_cb(promotion_page.reset_page);KT.panel.set_expand_cb(function(c){if(c==="new"){$("#new_changeset").submit(function(d){d.preventDefault();$("#save_changeset_button").trigger("click")})}});env_select.click_callback=promotion_page.env_change;registerEvents();$(document).ajaxComplete(function(e,g,d){var c=g.getResponseHeader("X-ChangesetUsers");if(c!==null&&c!==undefined){var f=$.parseJSON(c);promotion_page.checkUsersInResponse(f)}});KT.panel.registerPanel($("#changeset_tree"),$("#content_tree").width()+50);var a=$("#panel");$(document).bind("hash_change.slidingtree",function(){if(a.hasClass("opened")){KT.panel.closePanel(a)}})});jQuery.fn.sortElements=(function(){var a=[].sort;return function(c,d){d=d||function(){return this};var b=this.map(function(){var f=d.call(this),e=f.parentNode,g=e.insertBefore(document.createTextNode(""),f.nextSibling);return function(){if(e===this){throw new Error("You can't sort elements if any one is a descendant of another.")}e.insertBefore(this,g);e.removeChild(g)}});return a.call(this,c).each(function(e){b[e].call(d.call(this))})}})();var sliding_tree=function(a,e){var l=$("#"+a),q=l.find(".sliding_container .sliding_list"),c=l.find(".tree_breadcrumb"),n=l.find(".sliders"),k,j;var g=function(w){var u=p.breadcrumb[w],t=q.children(".no_content"),v=q.children(".has_content");p.current_tab=w;p.fetching=0;o(w);if(p.direction){v.removeClass("will_have_content");t.addClass("will_have_content")}if(!p.direction){t=v}p.prerender_cb(w);s(w,t)},s=function(v,u){if(p.breadcrumb[v]===undefined){v=p.default_tab}var t=p.breadcrumb[v];if(t.client_render){p.render_cb(v,function(w){u.html(w);p.tab_change_cb(v);b(v)})}else{if(t.cache){u.html(t.content);p.tab_change_cb(v);b(v)}else{p.fetching=v;$.get(t.url,function(w){if(p.fetching==v){if(w.html){u.html(w.html)}else{u.html(w)}p.fetching=0;p.tab_change_cb(v)}});b(v);u.html("<img src='images/spinner.gif' >")}}},b=function(y){var u=p.breadcrumb[y],t=q.children(".no_content"),w=q.children(".has_content");if(u.scrollable){q.addClass("ajaxScroll");q.attr("data-scroll_url",u.url)}else{q.removeClass("ajaxScroll")}if(p.direction){var x=p.direction=="right"?"left":"right",v=$(".sliding_container").width();if(x==="left"){q.css({left:0});w.after(t);q.animate({left:-v},500,function(){w.html("");w.removeClass("has_content");w.addClass("no_content");t.addClass("has_content");t.removeClass("no_content")})}else{q.css({left:-v});w.before(t);q.animate({left:0},500,function(){w.html("");w.removeClass("has_content");w.addClass("no_content");t.addClass("has_content");t.removeClass("no_content")})}p.direction=undefined}},r=function(u){var t=u.find(".link_details");if(t.hasClass("slide_left")){p.direction="left"}else{p.direction="right"}m(t.attr("id"))},m=function(u){var t={};t[p.bbq_tag]=u;$.bbq.pushState(t)},o=function(x){if(p.breadcrumb[x]===undefined){x=p.default_tab}var u=p.breadcrumb[x].trail,t=u,w="<ul>";k=x;c.html("");if(p.base_icon){if(u.length>0){w+=d(u[0],undefined,p.base_icon)}else{w+=d(x,true,p.base_icon)}t=u.slice(1,u.length)}else{if(u.length===0){w+='<li class="one-line-ellipsis"><div id="'+x+'" class="currentCrumb fl">'+p.breadcrumb[x].name+"</div></li>"}}if(u.length>0){for(var v=0;v<t.length;v++){w+=d(t[v])}w+='<li class="one-line-ellipsis"><div id="'+x+'" class="currentCrumb fl">'+p.breadcrumb[x].name+"</div></li>"}c.append(w)},d=function(w,t,v){var u='<li class="slide_link">';if(v){if(t){u+='<div class="'+v+' fl">'+w+"</div>"}else{u+='<div class="'+v+'_inactive fl">'+w+"</div>"}}u+='<div class="fl crumb link_details slide_left" id= "'+w+'">';if(!v){u+=p.breadcrumb[w].name}if(t===undefined){u+="\u2002\u00BB\u2002"}return u+"</div></li>"},h=function(){var t=$.bbq.getState(p.bbq_tag)||p.default_tab;if(p.current_tab!=t){g(t);$(document).trigger("hashchange."+a,[t])}},f=function(){var w,v=0,t=$("#filter_form"),u=$("#filter_input");t.submit(function(){u.change();return false});$(".filter_button").toggle(function(){w=$(".breadcrumb_filter");v=w.height();w.animate({height:v+40},{duration:200,queue:false});u.css("margin-left","4px");t.css("opacity","0").show();t.animate({opacity:"1"},{duration:200,queue:false});u.animate({width:(w.width()-60)+"px",opacity:"1"},{duration:200,queue:false});$(this).css({backgroundPosition:"-32px -16px"});$(this).attr("title",i18n.close);if($(".remove_item").length){$(".remove_item").css({top:52})}if($(".close").length){$(".close").css({top:52})}},function(){t.fadeOut("fast",function(){w.animate({height:v},"fast");if($(".remove_item").length){$(".remove_item").css({top:12})}if($(".close").length){$(".close").css({top:12})}});$(this).css({backgroundPosition:"0 -16px"});$(this).attr("title",i18n.filter);u.val("").change();$("#"+a+" .has_content .filterable li").fadeIn("fast")}).tipsy({fade:true,gravity:"s"});u.live("change, keyup",function(){if($.trim($(this).val()).length>=2){$("#"+a+" .has_content .filterable li:not(:contains('"+$(this).val()+"'))").filter(":not").fadeOut("fast");$("#"+a+" .has_content .filterable li:contains('"+$(this).val()+"')").filter(":hidden").fadeIn("fast")}else{$("#"+a+" .has_content .filterable li").fadeIn("fast")}});u.val("").change()},i=function(){j=sliding_tree.search();j.init(this,q)};var p={breadcrumb:{},bbq_tag:a,default_tab:"",current_tab:undefined,direction:undefined,base_icon:false,tab_change_cb:function(){},prerender_cb:function(){},render_cb:function(){},fetching:0};if(e){$.extend(p,e)}if(p.enable_filter){f()}if(p.enable_float){l.css("position","absolute");n.css("height",n.css("minHeight"))}$(window).unbind("hashchange."+a).bind("hashchange."+a,h);$(window).trigger("hashchange."+a);l.find(".slide_link").live("click",function(t){if(t.target.nodeName==="A"){return false}else{r($(this))}});return{get_current_crumb:function(){return k},get_breadcrumbs:function(){return p.breadcrumb},get_tree_id:function(){return a},render_content:m,rerender_content:function(){s($.bbq.getState(p.bbq_tag),q.children(".has_content"))},rerender_breadcrumb:function(){o($.bbq.getState(p.bbq_tag))},enableSearch:i}};sliding_tree.search=function(){var h,g=0,e,c,i,b,k=function(n,l){var m=n.get_tree_id();e=$("#search_form");c=$("#search_input");h=$(".breadcrumb_search");i=h.find(".search_button");g=h.height();b=n.get_breadcrumbs();i.toggle(function(){if(!i.hasClass("disabled")){f()}},function(){if(!i.hasClass("disabled")){j()}}).tipsy({fade:true,gravity:"s"});e.live("submit",function(q){var t=n.get_current_crumb(),p=b[t]["url"],s=s||0,r={},o=l.children(".has_content");q.preventDefault();if(b[t]["searchable"]){if($(this).serialize()!=="search="){$.bbq.pushState($(this).serialize())}p+="?offset="+s;o.html("<img src='images/spinner.gif' >");$(this).ajaxSubmit({url:p,data:r,cache:false,success:function(v){var u=v.html?v.html:v;o.html(u);$(document).trigger("search_complete.slidingtree")},error:function(u){}})}});$(document).bind("hashchange."+m,function(o,p){a(p)});a(n.get_current_crumb())},a=function(m){var l=b[m]["searchable"];$.bbq.removeState("search");d(l)},d=function(l){j();if(!l){i.css({backgroundPosition:"0 0"});i.addClass("disabled");i.attr("title",i18n.disabled_search)}else{i.css({backgroundPosition:"0 -16px"});i.removeClass("disabled");i.attr("title",i18n.search)}},f=function(){h.animate({height:g+40},{duration:200,queue:false});c.css("margin-left","4px");e.css("opacity","0").show();e.animate({opacity:"1"},{duration:200,queue:false});c.animate({width:(h.width()-60)+"px",opacity:"1"},{duration:200,queue:false});i.css({backgroundPosition:"-32px -16px"});i.attr("title",i18n.close)},j=function(){e.fadeOut("fast",function(){h.animate({height:g},"fast")});i.css({backgroundPosition:"0 -16px"});i.attr("title",i18n.search)};return{init:k,open:f,close:j}};sliding_tree.ActionBar=function(e){var f=undefined,e=e||{},a=function(j,i){var i=i||{};i.animate_time=500;if(f!==j&&f!==undefined){i.opening=false;e[f].setup_fn(i);$("#"+e[f].container).slideToggle(i.animate_time,function(){f=j;i.opening=true;h(i,j)})}else{if(f!==undefined){f=undefined;i.opening=false;h(i,j)}else{f=j;i.opening=true;h(i,j)}}},h=function(i,k){var j=$("#"+e[k].container);i=e[k].setup_fn(i);j.slideToggle(i.animate_time,i.after_function)},g=function(){if(f){a(f,{opening:false})}},d=function(){g()},b=function(j,i){if(e[j]!==undefined){delete e[j]}e[j]=i;c(j,i)},c=function(j,i){$("#"+i.button).unbind("click").click(function(){if($(this).hasClass("disabled")){return false}a(j,i.options)});$("#"+i.button).unbind("keypress").keypress(function(k){k.preventDefault();if($(this).hasClass("disabled")){return false}if(k.which===13){a(j,i.options)}})};for(item in e){c(item,e[item])}return{toggle:a,close:g,reset:d,add_to_toggle_list:b}};