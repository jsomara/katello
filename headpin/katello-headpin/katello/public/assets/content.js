(function(g){var j;var a;g.fn.treeTable=function(k){j=g.extend({},g.fn.treeTable.defaults,k);return this.each(function(){g(this).addClass("treeTable").find("tbody tr").each(function(){if(!j.expandable||g(this)[0].className.search(j.childPrefix)==-1){if(isNaN(a)){a=parseInt(g(g(this).children("td")[j.treeColumn]).css("padding-left"),10)}h(g(this))}else{if(j.initialState=="collapsed"){this.style.display="none"}}})})};g.fn.treeTable.defaults={childPrefix:"child-of-",clickableNodeNames:false,expandable:true,indent:19,initialState:"collapsed",onNodeShow:null,treeColumn:0};g.fn.collapse=function(){g(this).addClass("collapsed");i(g(this)).each(function(){if(!g(this).hasClass("collapsed")){g(this).collapse()}this.style.display="none"});return this};g.fn.expand=function(){g(this).removeClass("collapsed").addClass("expanded");i(g(this)).each(function(){h(g(this));if(g(this).is(".expanded.parent")){g(this).expand()}g(this).show();if(g.isFunction(j.onNodeShow)){j.onNodeShow.call()}});return this};g.fn.reveal=function(){g(b(g(this)).reverse()).each(function(){h(g(this));g(this).expand().show()});return this};g.fn.appendBranchTo=function(k){var n=g(this);var l=e(n);var m=g.map(b(g(k)),function(o){return o.id});if(g.inArray(n[0].id,m)==-1&&(!l||(k.id!=l[0].id))&&k.id!=n[0].id){c(n,b(n).length*j.indent*-1);if(l){n.removeClass(j.childPrefix+l[0].id)}n.addClass(j.childPrefix+k.id);d(n,k);c(n,b(n).length*j.indent)}return this};g.fn.reverse=function(){return this.pushStack(this.get().reverse(),arguments)};g.fn.toggleBranch=function(){if(g(this).hasClass("collapsed")){g(this).expand()}else{g(this).removeClass("expanded").collapse()}return this};function b(l){var k=[];while(l=e(l)){k[k.length]=l[0]}return k}function i(k){return g("table.treeTable tbody tr."+j.childPrefix+k[0].id)}function f(l){var k=parseInt(l[0].style.paddingLeft,10);return(isNaN(k))?a:k}function c(l,m){var k=g(l.children("td")[j.treeColumn]);k[0].style.paddingLeft=f(k)+m+"px";i(l).each(function(){c(g(this),m)})}function h(l){if(!l.hasClass("initialized")){l.addClass("initialized");var n=i(l);if(!l.hasClass("parent")&&n.length>0){l.addClass("parent")}if(l.hasClass("parent")){var k=g(l.children("td")[j.treeColumn]);var m=f(k)+j.indent;n.each(function(){g(this).children("td")[j.treeColumn].style.paddingLeft=m+"px"});if(j.expandable){k.prepend('<span style="margin-left: -'+j.indent+"px; padding-left: "+j.indent+'px" class="expander"></span>');g(k[0].firstChild).click(function(){l.toggleBranch()});if(j.clickableNodeNames){k[0].style.cursor="pointer";g(k).click(function(o){if(o.target.className!="expander"){l.toggleBranch()}})}if(!(l.hasClass("expanded")||l.hasClass("collapsed"))){l.addClass(j.initialState)}if(l.hasClass("expanded")){l.expand()}}}}}function d(l,k){l.insertAfter(k);i(l).reverse().each(function(){d(g(this),l[0])})}function e(l){var m=l[0].className.split(" ");for(var k=0;k<m.length;k++){if(m[k].match(j.childPrefix)){return g("#"+m[k].substring(9))}}return null}})(jQuery);$(document).ready(function(){var a=[];$.each(KT.repo_status,function(c,b){if(b.is_running){a.push(c);KT.content.draw_syncing(c,b.progress.progress)}});KT.content.reset_products(KT.repo_status);KT.content_actions.addSyncing(a);$("#select_all").click(KT.content.select_all);$("#select_none").click(KT.content.select_none);$("#collapse_all").click(KT.content.collapse_all);$("#expand_all").click(KT.content.expand_all);KT.content.showAll();$("#products_table").delegate(".cancel_sync","click",function(){var b=$(this).parents("tr").attr("data-id");KT.content_actions.cancelSync(b,$(this))});$("#sync_product_form").bind("ajax:success",function(c,f,b,g){var d=$.parseJSON(f);var e=[];$.each(d,function(h,i){e.push(i.id);KT.content.draw_syncing(i.id,0);KT.content.updateProduct(i.product_id,false,0)});KT.content_actions.addSyncing(e)}).bind("ajax:beforeSend",function(c,d,b,e){if($("input[name='repoids[]']:checked").length===0){return false}});$("#sync_toggle").change(function(){var b="<img  src='"+KT.common.spinner_path()+"'>";$("#sync_toggle_cont").append(b);if($(this).is(":checked")){KT.content.showOnlySyncing()}else{KT.content.showAll()}$("#sync_toggle_cont").find("img").remove()})});KT.content_actions=(function(){var b=[],f=undefined,d=function(h){if(h.length===0){return}var i=b.length===0&&f;$.each(h,function(j,k){b.push(k+"")});if(!f){g()}else{if(i){f.restart()}}},e=function(h){b.splice($.inArray(h+"",b),1);if(b.length===0&&f){f.stop()}},c=function(){return b},a=function(h){$.ajax({type:"DELETE",url:KT.routes.sync_management_path(h),dataType:"json",success:function(i){e(h);KT.content.cancelRepo(h)},error:function(i){}})},g=function(){if(b.length===0){return}f=$.PeriodicalUpdater(KT.routes.sync_management_sync_status_path(),{data:function(){return{repoids:c()}},method:"get",type:"json",global:false},function(h,i){if(i=="notmodified"){return}$.each(h,function(j,k){if(!k.is_running){e(k.id);KT.content.finishRepo(k.id,k.state,k.duration)}else{KT.content.updateRepo(k.id,k.start_time,k.duration,k.progress.progress,k.size,k.packages)}});KT.content.reset_products(h)},function(){f.stop()})};return{cancelSync:a,addSyncing:d,startUpdater:g,getSyncing:function(){return b}}})();KT.content=(function(){var b=function(s,q){var r=$("#repo-"+s).find(".result"),u=$("<a/>").attr("class","cancel_sync").text(i18n.cancel),t=$("<div/>").attr("class","progress").text(" ");q=q?q:0;t.progressbar({value:q});r.html("");r.append(t).append(u)},i=function(t,w,v,q,s,u){var r=$("#repo-"+t);m(r,w,v,q,s,u)},h=function(r,s,t){var q=$("#repo-"+r);q.find(".result").html(s);e(q.find(".duration"),t)},n=function(s){var r=$("#repo-"+s);var q=r.attr("data-product_id");var t=[];e(r.find(".result"),i18n.cancelled);$.each(KT.content_actions.getSyncing(),function(v,u){if(q===$("#repo-"+u).attr("data-product_id")){t.push(u)}});if(t.length===0){$("#product-"+q).find(".result").html("")}else{}},m=function(s,v,u,q,r,t){e(s.find(".start_time"),v);e(s.find(".duration"),u);e(s.find(".size"),r+" ("+t+")");var w=s.find(".progress");if(q===100){w.find(".ui-progressbar-value").animate({width:99},{queue:false,duration:"slow",easing:"easeInSine"})}else{w.progressbar({value:q})}},d=function(r,q,u){var s=$("#product-"+r).find(".result");var v=s.find(".progress");if(q){s.html("")}else{var w=$("<div/>").attr("class","progress").text(" ");s.html(w);if(u===100){var t=v?v.progressbar("option","value"):0;w.progressbar({value:t});w.find(".ui-progressbar-value").animate({width:99},{queue:false,duration:"slow",easing:"easeInSine"})}else{w.progressbar({value:u})}}},e=function(q,r){q.text(r)},l=function(){$("#products_table").find("input[type=checkbox]").attr("checked",true)},o=function(){$("#products_table").find("input[type=checkbox]").removeAttr("checked")},g=function(){$("input[name='repoids[]']:checked").length>0?$("#sync_button").removeClass("disabled"):$("#sync_button").addClass("disabled")},k=function(q){var r={};$.each(q,function(t,u){var s=u.product_id;if(r[s]===undefined){r[s]=[]}if(u.is_running){r[s].push(u.progress.progress)}});$.each(r,function(t,s){var u=0;$.each(s,function(v,w){u+=w});d(t,s.length===0,u/s.length)})},p=function(){$("#products_table").find("tbody").find("tr").hide();$.each(KT.content_actions.getSyncing(),function(q,s){var r=$("#repo-"+s);j(r)})},j=function(q){q.show().addClass("expanded").removeClass("collapsed");$.each(q.attr("class").split(" "),function(s,r){if(r.indexOf("child-of-")===0){var t=r.split("child-of-")[1];j($("#"+t))}})},c=function(){var q=$("#products_table").find("tbody").find("tr").show().removeClass("expanded").addClass("collapsed");$("#products_table").treeTable({clickableNodeNames:true,indent:15})},a=function(){$("#products_table").find("tr").removeClass("collapsed").addClass("expanded").each(function(){$(this).expand()})},f=function(){$("#products_table").find("tr").removeClass("expanded").addClass("collapsed").each(function(){$(this).collapse()})};return{cancelRepo:n,updateProduct:d,updateRepo:i,finishRepo:h,select_all:l,select_none:o,select_repo:g,draw_syncing:b,reset_products:k,showOnlySyncing:p,showAll:c,expand_all:a,collapse_all:f}})();(function(b){var a=function(d){try{}catch(c){}};b.PeriodicalUpdater=function(d,c,e,h){var r=jQuery.extend(true,{url:d,cache:false,method:"GET",data:"",minTimeout:1000,maxTimeout:8000,multiplier:2,maxCalls:0,autoStop:0},c);var i=null;var m=r.minTimeout;var q=r.maxCalls;var k=r.autoStop;var l=0;var n=0;var o=q;var j=function(v){if(i!=null){clearTimeout(i)}m=v;a("resetting timer to "+m+".");i=setTimeout(f,m)};var t=function(){if(r.multiplier>=1){before=m;m=m*r.multiplier;if(m>r.maxTimeout){m=r.maxTimeout}after=m;a("adjusting timer from "+before+" to "+after+".");j(m)}};var g=jQuery.extend(true,{},r);if(r.type&&!g.dataType){g.dataType=r.type}if(r.sendData){g.data=r.sendData}g.type=r.method;g.ifModified=true;var s={restart:function(){q=o;l=0;j(m);return},stop:function(){q=-1;return}};function f(){var v=jQuery.extend(true,{},g);if(typeof(c.data)=="function"){v.data=c.data();if(v.data){if(typeof(v.data)=="number"){v.data=v.data.toString()}}}if(q==0){b.ajax(v)}else{if(q>0&&l<q){b.ajax(v);l++}}}var p=null;var u=null;g.success=function(v){a("Successful run! (In 'success')");p=v};g.complete=function(w,v){if(q==-1){return}if(v=="success"||v=="notmodified"){var x=b.trim(w.responseText);if(x=="STOP_AJAX_CALLS"){s.stop();return}if(u==x){if(k>0){n++;if(n==k){s.stop();if(h){h(n)}return}}t()}else{n=0;j(r.minTimeout);u=x;if(p==null){p=x}if((g.dataType==="json")&&(typeof(p)==="string")&&(v=="success")){p=JSON.parse(p)}if(r.success){r.success(p,v,w,s)}if(e){e(p,v,w,s)}}}p=null};g.error=function(v,w){if(w!="notmodified"){u=null;j(r.minTimeout)}if(r.error){r.error(v,w)}};b(function(){j(m)});return s}})(jQuery);