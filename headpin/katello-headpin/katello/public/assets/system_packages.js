KT.package_action_types=function(){return{PKG:"pkg",PKG_INSTALL:"pkg_install",PKG_UPDATE:"pkg_update",PKG_REMOVE:"pkg_remove",PKG_GRP:"pkg_grp",PKG_GRP_INSTALL:"pkg_grp_install",PKG_GRP_UPDATE:"pkg_grp_update",PKG_GRP_REMOVE:"pkg_grp_remove"}}();KT.packages=function(){var y=$(".packages").attr("data-system_id"),F=true,K=$(".packages").attr("data-total_packages"),O=$("#more"),E=$("#package_sort"),Y=$("#packages_form"),Q=$("#remove_packages"),e=$("#update_packages"),l=$("#update_all_packages"),k=$("#content_form_row"),U=$("#content_form"),v=$("#content_input"),aa=$("#add_content"),I=$("#remove_content"),z=$("#loaded_summary"),s=$("#error_message"),V=false,a=0,q={},H={},x={},g=undefined,G=function(){Q.attr("disabled","disabled");e.attr("disabled","disabled");Q.addClass("disabled");e.addClass("disabled")},h=function(){Q.removeAttr("disabled");e.removeAttr("disabled");Q.removeClass("disabled");e.removeClass("disabled")},m=function(){l.attr("disabled","disabled");l.addClass("disabled")},b=function(){l.removeAttr("disabled");l.removeClass("disabled")},A=function(){aa.unbind("click");I.unbind("click");aa.attr("disabled","disabled");I.attr("disabled","disabled");aa.addClass("disabled");I.addClass("disabled")},T=function(){if(aa.hasClass("disabled")){aa.bind("click",N);aa.removeAttr("disabled");aa.removeClass("disabled")}if(I.hasClass("disabled")){I.bind("click",r);I.removeAttr("disabled");I.removeClass("disabled")}},t=function(ab){var ac=undefined;if(ab.find('td.package_action_status:contains("'+i18n.adding_package+'")').length>0){ac=KT.package_action_types.PKG_INSTALL}else{if(ab.find('td.package_action_status:contains("'+i18n.updating_package+'")').length>0){ac=KT.package_action_types.PKG_UPDATE}else{if(ab.find('td.package_action_status:contains("'+i18n.removing_package+'")').length>0){ac=KT.package_action_types.PKG_REMOVE}else{if(ab.find('td.package_action_status:contains("'+i18n.adding_group+'")').length>0){ac=KT.package_action_types.PKG_GRP_INSTALL}else{if(ab.find('td.package_action_status:contains("'+i18n.removing_group+'")').length>0){ac=KT.package_action_types.PKG_GRP_REMOVE}}}}}return ac},Z=function(){var ac=$(".packages");var ae=$("#list-spinner");var ab=O.attr("data-scroll_url");var ad=parseInt(O.attr("data-offset"),10);ab=ab+"?offset="+ad+"&pkg_order="+E.attr("data-sort")+"&";ae.fadeIn();$.ajax({type:"GET",url:ab,cache:false,success:function(af){F=false;ae.fadeOut();ac.append(af);c();$("#filter").keyup();$(".scroll-pane").jScrollPane().data("jsp").reinitialise();d();if(af.length==0){O.empty().remove()}else{ad=ad+parseInt(O.attr("data-page_size"),10);O.attr("data-offset",ad)}},error:function(){ae.fadeOut();F=false}})},o=function(){var ab=E.attr("data-sort");if(E.attr("data-sort")=="asc"){ab="desc";E.removeClass("ascending").addClass("descending")}else{ab="asc";E.removeClass("descending").addClass("ascending")}E.attr("data-sort",ab);return ab},M=function(){var ad=$(".packages");var ae=$("#list-spinner");var ab=O.attr("data-scroll_url");var ac=parseInt(O.attr("data-offset"),10);ab=ab+"?reverse="+ac+"&pkg_order="+KT.packages.sortOrder()+"&";ae.fadeIn();ad.find("tbody > tr.package").empty().remove();$.ajax({type:"GET",url:ab,cache:false,success:function(af){F=false;ae.fadeOut();ad.append(af);c();$("#filter").keyup();$(".scroll-pane").jScrollPane().data("jsp").reinitialise();d();if(af.length==0){O.empty().remove()}else{O.attr("data-offset",ac)}},error:function(){ae.fadeOut();F=false}})},c=function(){var ab=$('input[type="checkbox"]');ab.unbind("change");ab.each(function(){$(this).change(function(){if($(this).is(":checked")){a++;h();m()}else{a--;if(a==0){G();b()}}})})},B=function(ab){$.each(ab,function(af,ad){var ag=q[ad.uuid],ac=$('tr[data-uuid="'+ad.uuid+'"]'),ae=ac.find("td.package_action_status");switch(ad.state){case"waiting":case"running":break;case"error":switch(ag){case KT.package_action_types.PKG_INSTALL:ae.html(i18n.adding_package_failed);f(ad.uuid,ad.parameters,KT.package_action_types.PKG);break;case KT.package_action_types.PKG_UPDATE:ae.html(i18n.updating_package_failed);f(ad.uuid,ad.parameters,KT.package_action_types.PKG);break;case KT.package_action_types.PKG_REMOVE:ae.html(i18n.removing_package_failed);f(ad.uuid,ad.parameters,KT.package_action_types.PKG);break;case KT.package_action_types.PKG_GRP_INSTALL:ae.html(i18n.adding_group_failed);f(ad.uuid,ad.parameters,KT.package_action_types.PKG_GRP);break;case KT.package_action_types.PKG_GRP_REMOVE:ae.html(i18n.removing_group_failed);f(ad.uuid,ad.parameters,KT.package_action_types.PKG_GRP);break}break;case"finished":switch(ag){case KT.package_action_types.PKG_INSTALL:ae.html(i18n.adding_package_success);f(ad.uuid,ad.parameters,KT.package_action_types.PKG);break;case KT.package_action_types.PKG_UPDATE:ae.html(i18n.updating_package_success);f(ad.uuid,ad.parameters,KT.package_action_types.PKG);break;case KT.package_action_types.PKG_REMOVE:ae.html(i18n.removing_package_success);f(ad.uuid,ad.parameters,KT.package_action_types.PKG);break;case KT.package_action_types.PKG_GRP_INSTALL:ae.html(i18n.adding_group_success);f(ad.uuid,ad.parameters,KT.package_action_types.PKG_GRP);break;case KT.package_action_types.PKG_GRP_REMOVE:ae.html(i18n.removing_group_success);f(ad.uuid,ad.parameters,KT.package_action_types.PKG_GRP);break}break;case"canceled":switch(ag){case KT.package_action_types.PKG_INSTALL:ae.html(i18n.adding_package_canceled);f(ad.uuid,ad.parameters,KT.package_action_types.PKG);break;case KT.package_action_types.PKG_UPDATE:ae.html(i18n.updating_package_canceled);f(ad.uuid,ad.parameters,KT.package_action_types.PKG);break;case KT.package_action_types.PKG_REMOVE:ae.html(i18n.removing_package_canceled);f(ad.uuid,ad.parameters,KT.package_action_types.PKG);break;case KT.package_action_types.PKG_GRP_INSTALL:ae.html(i18n.adding_group_canceled);f(ad.uuid,ad.parameters,KT.package_action_types.PKG_GRP);break;case KT.package_action_types.PKG_GRP_REMOVE:ae.html(i18n.removing_group_canceled);f(ad.uuid,ad.parameters,KT.package_action_types.PKG_GRP);break}break;case"timed_out":switch(ag){case KT.package_action_types.PKG_INSTALL:ae.html(i18n.adding_package_timeout);f(ad.uuid,ad.parameters,KT.package_action_types.PKG);break;case KT.package_action_types.PKG_UPDATE:ae.html(i18n.updating_package_timeout);f(ad.uuid,ad.parameters,KT.package_action_types.PKG);break;case KT.package_action_types.PKG_REMOVE:ae.html(i18n.removing_package_timeout);f(ad.uuid,ad.parameters,KT.package_action_types.PKG);break;case KT.package_action_types.PKG_GRP_INSTALL:ae.html(i18n.adding_group_timeout);f(ad.uuid,ad.parameters,KT.package_action_types.PKG_GRP);break;case KT.package_action_types.PKG_GRP_REMOVE:ae.html(i18n.removing_group_timeout);f(ad.uuid,ad.parameters,KT.package_action_types.PKG_GRP);break}break}})},f=function(ab,ad,ac){w(ab);$.each(ad,function(ae,af){var ag=af.toString().split(",");$.each(ag,function(ai,ah){if(ac===KT.package_action_types.PKG){delete H[ah]}else{if(ac===KT.package_action_types.PKG_GRP){delete x[ah]}}})})},p=function(){var ab=8000;g=$.PeriodicalUpdater(KT.routes.status_system_system_packages_path(y),{method:"get",type:"json",data:function(){return{uuid:Object.keys(q)}},global:false,minTimeout:ab,maxTimeout:ab},B)},D=function(ab,ac){q[ab]=ac;if(g===undefined){p()}else{g.restart()}},w=function(ab){delete q[ab];if(Object.keys(q).length===0){g.stop()}},X=function(){W();P();G();b();d()},W=function(){if(g!==undefined){g.stop()}$("tr.content_package").each(function(){q[$(this).attr("data-uuid")]=t($(this));H[$.trim($(this).find("td.package_name").html())]=true});$("tr.content_group").each(function(){q[$(this).attr("data-uuid")]=t($(this));H[$.trim($(this).find("td.package_name").html())]=true});if(Object.keys(q).length>0){if(g===undefined){p()}else{g.restart()}}},P=function(){v.bind("change, keyup",J);O.bind("click",Z);E.bind("click",M);Q.bind("click",L);e.bind("click",n);l.bind("click",u);c()},J=function(ab){if($.trim($(this).val()).length==0){A()}else{T()}},N=function(ae){ae.preventDefault();var af=$("input[@name=perform_action]:checked").attr("id"),ad=U.find("#content_input").val(),ac=ad.split(/ *, */),ab=undefined;if(af=="perform_action_packages"){ab=j(ac,KT.package_action_types.PKG);if(ab===undefined){A();$.ajax({url:KT.routes.add_system_system_packages_path(y),type:"PUT",data:{packages:ad},cache:false,success:function(ah){D(ah,KT.package_action_types.PKG_INSTALL);for(i=0;i<ac.length;i++){var ag=$.trim(ac[i]),ai=false;H[ag]=true;$("tr.content_package").find("td.package_name").each(function(){if($.trim($(this).html())===ag){ai=true;$(this).parent().attr("data-uuid",ah);$(this).parent().find("td.package_action_status").html('<img style="padding-right:8px;" src="images/spinner.gif">'+i18n.adding_package)}});if(ai===false){if(V){V=false;k.after('<tr class="alt content_package" data-uuid='+ah+'><td></td><td class="package_name">'+ag+'</td><td class="package_action_status"><img style="padding-right:8px;" src="images/spinner.gif">'+i18n.adding_package+"</td></tr>")}else{V=true;k.after('<tr class="content_package" data-uuid='+ah+'><td></td><td class="package_name">'+ag+'</td><td class="package_action_status"><img style="padding-right:8px;" src="images/spinner.gif">'+i18n.adding_package+"</td></tr>")}}}T();C(false)},error:function(){T()}})}else{C(true,ab)}}else{ab=j(ac,KT.package_action_types.PKG_GRP);if(ab===undefined){A();$.ajax({url:KT.routes.add_system_system_packages_path(y),type:"PUT",data:{groups:ad},cache:false,success:function(ag){D(ag,KT.package_action_types.PKG_GRP_INSTALL);for(i=0;i<ac.length;i++){var ai=$.trim(ac[i]),ah=false;x[ai]=true;$("tr.content_group").find("td.package_name").each(function(){if($.trim($(this).html())===ai){ah=true;$(this).parent().attr("data-uuid",ag);$(this).parent().find("td.package_action_status").html('<img style="padding-right:8px;" src="images/spinner.gif">'+i18n.adding_group)}});if(ah===false){if(V){V=false;k.after('<tr class="alt content_group" data-uuid='+ag+'><td></td><td class="package_name">'+ai+'</td><td class="package_action_status"><img style="padding-right:8px;" src="images/spinner.gif">'+i18n.adding_group+"</td></tr>")}else{V=true;k.after('<tr class="content_group" data-uuid='+ag+'><td></td><td class="package_name">'+ai+'</td><td class="package_action_status"><img style="padding-right:8px;" src="images/spinner.gif">'+i18n.adding_group+"</td></tr>")}}}T();C(false)},error:function(){T()}})}else{C(true,ab)}}},r=function(ae){ae.preventDefault();var af=$("input[@name=perform_action]:checked").attr("id"),ad=U.find("#content_input").val(),ac=ad.split(/ *, */),ab=undefined;if(af=="perform_action_packages"){ab=j(ac,KT.package_action_types.PKG);if(ab===undefined){A();$.ajax({url:KT.routes.remove_system_system_packages_path(y),type:"POST",data:{packages:ad},cache:false,success:function(ah){D(ah,KT.package_action_types.PKG_REMOVE);for(i=0;i<ac.length;i++){var ag=$.trim(ac[i]),ai=false;H[ag]=true;$("tr.content_package").find("td.package_name").each(function(){if($.trim($(this).html())===ag){ai=true;$(this).parent().attr("data-uuid",ah);$(this).parent().find("td.package_action_status").html('<img style="padding-right:8px;" src="images/spinner.gif">'+i18n.removing_package)}});if(ai===false){if(V){V=false;k.after('<tr class="alt content_package" data-uuid='+ah+'><td></td><td class="package_name">'+ag+'</td><td class="package_action_status"><img style="padding-right:8px;" src="images/spinner.gif">'+i18n.removing_package+"</td></tr>")}else{V=true;k.after('<tr class="content_package" data-uuid='+ah+'><td></td><td class="package_name">'+ag+'</td><td class="package_action_status"><img style="padding-right:8px;" src="images/spinner.gif">'+i18n.removing_package+"</td></tr>")}}}T();C(false)},error:function(){T()}})}else{C(true,ab)}}else{ab=j(ac,KT.package_action_types.PKG_GRP);if(ab===undefined){A();$.ajax({url:KT.routes.remove_system_system_packages_path(y),type:"POST",data:{groups:ad},cache:false,success:function(ag){D(ag,KT.package_action_types.PKG_GRP_REMOVE);for(i=0;i<ac.length;i++){var ai=$.trim(ac[i]),ah=false;x[ai]=true;$("tr.content_group").find("td.package_name").each(function(){if($.trim($(this).html())===ai){ah=true;$(this).parent().attr("data-uuid",ag);$(this).parent().find("td.package_action_status").html('<img style="padding-right:8px;" src="images/spinner.gif">'+i18n.removing_group)}});if(ah===false){if(V){V=false;k.after('<tr class="alt content_group" data-uuid='+ag+'><td></td><td class="package_name">'+ai+'</td><td class="package_action_status"><img style="padding-right:8px;" src="images/spinner.gif">'+i18n.removing_group+"</td></tr>")}else{V=true;k.after('<tr class="content_group" data-uuid='+ag+'><td></td><td class="package_name">'+ai+'</td><td class="package_action_status"><img style="padding-right:8px;" src="images/spinner.gif">'+i18n.removing_group+"</td></tr>")}}}T();C(false)},error:function(){T()}})}else{C(true,ab)}}},L=function(ab){ab.preventDefault();G();Y.ajaxSubmit({url:Q.attr("data-url"),type:"POST",success:function(ac){$(":checkbox:checked").each(function(){var ad=$(this).closest(".package");ad.attr("data-uuid",ac);ad.find(".package_action_status").html('<img style="padding-right:8px;" src="images/spinner.gif">'+i18n.removing_package)});D(ac,KT.package_action_types.PKG_REMOVE);h()},error:function(){h()}})},n=function(ab){ab.preventDefault();G();Y.ajaxSubmit({url:e.attr("data-url"),type:"POST",success:function(ac){$(":checkbox:checked").each(function(){var ad=$(this).closest(".package");ad.attr("data-uuid",ac);ad.find(".package_action_status").html('<img style="padding-right:8px;" src="images/spinner.gif">'+i18n.updating_package)});D(ac,KT.package_action_types.PKG_UPDATE);h()},error:function(){h()}})},u=function(ab){ab.preventDefault();G();$.ajax({url:e.attr("data-url"),type:"POST",cache:false,success:function(){b()},error:function(){b()}})},d=function(){var ac=$("tr.package").length,ab=i18n.x_of_y_packages(ac,K);z.html(ab);if(ac>=K){O.remove()}},j=function(ae,ac){var ab=undefined;if((ac===KT.package_action_types.PKG)&&!S(ae)){ab=i18n.validation_error_name_format}else{var ad;$.each(ae,function(af,ag){ad=$.trim(ag);switch(ac){case KT.package_action_types.PKG:if(H[ad]===true){ab=i18n.validation_error_package_pending;break}break;case KT.package_action_types.PKG_GRP:if(x[ad]===true){ab=i18n.validation_error_group_pending;break}break}})}return ab},C=function(ac,ab){var ad=U.find("#content_input");if(ac){ad.addClass("validation_error_input");s.html(ab);s.show()}else{ad.removeClass("validation_error_input");s.hide()}},S=function(ad){var ab,ac=ad.length;for(ab=0;ab<ac;ab+=1){if(!R(ad[ab])){return false}}return true},R=function(ab){var ac=ab.match(/[^abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789\-\.\_\+\,]+/);return ac===null?true:false};return{morePackages:Z,sortOrder:o,reverseSort:M,initPackages:X,addContent:N,removeContent:r,removePackages:L,updatePackages:n,updateAllPackages:u}}();$(document).ready(function(){KT.packages.initPackages()});