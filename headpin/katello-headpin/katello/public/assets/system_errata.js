KT.system=KT.system||{};KT.system.errata=function(){var p=$("#system_errata"),m=p.data("system_id"),t=p.find("tbody"),d=$("#load_more_errata"),e={},f,l=function(){a();s();i(true);j({data:{clear_items:false}})},a=function(){$("#display_errata_type").bind("change",{clear_items:true},j);$("#select_all_errata").bind("change",o);$("#errata_state_radio_applied").bind("change",j);$("#errata_state_radio_outstanding").bind("change",j);$("#run_errata_button").bind("click",n);d.bind("click",{clear_items:false},j);KT.tipsy.custom.errata_tooltip()},s=function(){var u=8000;f=$.PeriodicalUpdater(KT.routes.status_system_errata_path(m),{method:"get",type:"json",data:function(){return{uuid:Object.keys(e)}},global:false,minTimeout:u,maxTimeout:u},k)},j=function(w){var v=g(),x=b(),y,u=w.data?w.data.clear_items:false;if(u){r({html:"",results_count:0,total_count:0,current_count:0},false);i(true)}y=u?0:$("#loaded_summary").data("current_count");$.ajax({method:"get",url:KT.routes.items_system_errata_path(m),data:{filter_type:v,offset:y,errata_state:x},}).success(function(z){r(z,!u);i(false)})},g=function(){return $("#display_errata_type").val()},b=function(){return $("input[@name=errata_state_radio]:checked").val()},o=function(){var u=t.find(":checkbox");if($("#select_all_errata").attr("checked")){u.attr("checked",true)}else{u.attr("checked",false)}},n=function(){var u=$("#system_errata").find(":checkbox:checked"),v=[],w={};$.each(u,function(x,y){v.push($(y).val())});h(v,"installing");w.errata_ids=v;w=$.param(w);$.ajax({url:KT.routes.install_system_errata_path(m),type:"POST",data:w}).success(function(x){if(Object.keys(e).length===0){f.restart()}e[x]=v})},k=function(x){var v=0,w=x.length,u;for(v;v<w;v+=1){u=x[v];if(u.state==="finished"){h(e[u.uuid],"finished");delete e[u.uuid]}else{if(u.state==="running"){if(!e.hasOwnProperty(u.uuid)){e[u.uuid]=u.parameters["errata_ids"];h(u.parameters["errata_ids"],"installing")}}}}if(Object.keys(e).length===0){f.stop()}},r=function(w,u){var v=w.html;if(u){t.append(v)}else{t.html(v)}q(w)},q=function(w){var u=w.current_count,v=w.total_count,x=w.results_count;$("#loaded_summary").data("current_count",u),$("#loaded_summary").html(i18n.x_of_y_errata(u,x,v));if(u===x){d.hide()}else{d.show()}},i=function(u){if(u){$("#list-spinner").show()}else{$("#list-spinner").hide()}},h=function(z,v){var y=c(z),u,w,x;x=y.length;for(w=0;w<x;w+=1){u=y[w];if(v==="installing"){u.find(".errata_status_text").html(i18n.errata_installing);u.find("img").show()}else{if(v==="finished"){u.find("img").hide();u.find(".errata_status_text").html(i18n.errata_install_finished)}}u.find(".errata_status").show()}},c=function(x){var u=0,v=x.length,w=[];for(u;u<v;u+=1){w.push($("#system_errata_"+KT.common.escapeId(x[u])))}return w};return{init:l}}();$(document).ready(function(){KT.system.errata.init()});