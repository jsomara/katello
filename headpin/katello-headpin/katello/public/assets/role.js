KT.panel.list.registerPage("roles",{create:"new_role"});var sliding_tree=function(a,e){var l=$("#"+a),q=l.find(".sliding_container .sliding_list"),c=l.find(".tree_breadcrumb"),n=l.find(".sliders"),k,j;var g=function(w){var u=p.breadcrumb[w],t=q.children(".no_content"),v=q.children(".has_content");p.current_tab=w;p.fetching=0;o(w);if(p.direction){v.removeClass("will_have_content");t.addClass("will_have_content")}if(!p.direction){t=v}p.prerender_cb(w);s(w,t)},s=function(v,u){if(p.breadcrumb[v]===undefined){v=p.default_tab}var t=p.breadcrumb[v];if(t.client_render){p.render_cb(v,function(w){u.html(w);p.tab_change_cb(v);b(v)})}else{if(t.cache){u.html(t.content);p.tab_change_cb(v);b(v)}else{p.fetching=v;$.get(t.url,function(w){if(p.fetching==v){if(w.html){u.html(w.html)}else{u.html(w)}p.fetching=0;p.tab_change_cb(v)}});b(v);u.html("<img src='images/spinner.gif' >")}}},b=function(y){var u=p.breadcrumb[y],t=q.children(".no_content"),w=q.children(".has_content");if(u.scrollable){q.addClass("ajaxScroll");q.attr("data-scroll_url",u.url)}else{q.removeClass("ajaxScroll")}if(p.direction){var x=p.direction=="right"?"left":"right",v=$(".sliding_container").width();if(x==="left"){q.css({left:0});w.after(t);q.animate({left:-v},500,function(){w.html("");w.removeClass("has_content");w.addClass("no_content");t.addClass("has_content");t.removeClass("no_content")})}else{q.css({left:-v});w.before(t);q.animate({left:0},500,function(){w.html("");w.removeClass("has_content");w.addClass("no_content");t.addClass("has_content");t.removeClass("no_content")})}p.direction=undefined}},r=function(u){var t=u.find(".link_details");if(t.hasClass("slide_left")){p.direction="left"}else{p.direction="right"}m(t.attr("id"))},m=function(u){var t={};t[p.bbq_tag]=u;$.bbq.pushState(t)},o=function(x){if(p.breadcrumb[x]===undefined){x=p.default_tab}var u=p.breadcrumb[x].trail,t=u,w="<ul>";k=x;c.html("");if(p.base_icon){if(u.length>0){w+=d(u[0],undefined,p.base_icon)}else{w+=d(x,true,p.base_icon)}t=u.slice(1,u.length)}else{if(u.length===0){w+='<li class="one-line-ellipsis"><div id="'+x+'" class="currentCrumb fl">'+p.breadcrumb[x].name+"</div></li>"}}if(u.length>0){for(var v=0;v<t.length;v++){w+=d(t[v])}w+='<li class="one-line-ellipsis"><div id="'+x+'" class="currentCrumb fl">'+p.breadcrumb[x].name+"</div></li>"}c.append(w)},d=function(w,t,v){var u='<li class="slide_link">';if(v){if(t){u+='<div class="'+v+' fl">'+w+"</div>"}else{u+='<div class="'+v+'_inactive fl">'+w+"</div>"}}u+='<div class="fl crumb link_details slide_left" id= "'+w+'">';if(!v){u+=p.breadcrumb[w].name}if(t===undefined){u+="\u2002\u00BB\u2002"}return u+"</div></li>"},h=function(){var t=$.bbq.getState(p.bbq_tag)||p.default_tab;if(p.current_tab!=t){g(t);$(document).trigger("hashchange."+a,[t])}},f=function(){var w,v=0,t=$("#filter_form"),u=$("#filter_input");t.submit(function(){u.change();return false});$(".filter_button").toggle(function(){w=$(".breadcrumb_filter");v=w.height();w.animate({height:v+40},{duration:200,queue:false});u.css("margin-left","4px");t.css("opacity","0").show();t.animate({opacity:"1"},{duration:200,queue:false});u.animate({width:(w.width()-60)+"px",opacity:"1"},{duration:200,queue:false});$(this).css({backgroundPosition:"-32px -16px"});$(this).attr("title",i18n.close);if($(".remove_item").length){$(".remove_item").css({top:52})}if($(".close").length){$(".close").css({top:52})}},function(){t.fadeOut("fast",function(){w.animate({height:v},"fast");if($(".remove_item").length){$(".remove_item").css({top:12})}if($(".close").length){$(".close").css({top:12})}});$(this).css({backgroundPosition:"0 -16px"});$(this).attr("title",i18n.filter);u.val("").change();$("#"+a+" .has_content .filterable li").fadeIn("fast")}).tipsy({fade:true,gravity:"s"});u.live("change, keyup",function(){if($.trim($(this).val()).length>=2){$("#"+a+" .has_content .filterable li:not(:contains('"+$(this).val()+"'))").filter(":not").fadeOut("fast");$("#"+a+" .has_content .filterable li:contains('"+$(this).val()+"')").filter(":hidden").fadeIn("fast")}else{$("#"+a+" .has_content .filterable li").fadeIn("fast")}});u.val("").change()},i=function(){j=sliding_tree.search();j.init(this,q)};var p={breadcrumb:{},bbq_tag:a,default_tab:"",current_tab:undefined,direction:undefined,base_icon:false,tab_change_cb:function(){},prerender_cb:function(){},render_cb:function(){},fetching:0};if(e){$.extend(p,e)}if(p.enable_filter){f()}if(p.enable_float){l.css("position","absolute");n.css("height",n.css("minHeight"))}$(window).unbind("hashchange."+a).bind("hashchange."+a,h);$(window).trigger("hashchange."+a);l.find(".slide_link").live("click",function(t){if(t.target.nodeName==="A"){return false}else{r($(this))}});return{get_current_crumb:function(){return k},get_breadcrumbs:function(){return p.breadcrumb},get_tree_id:function(){return a},render_content:m,rerender_content:function(){s($.bbq.getState(p.bbq_tag),q.children(".has_content"))},rerender_breadcrumb:function(){o($.bbq.getState(p.bbq_tag))},enableSearch:i}};sliding_tree.search=function(){var h,g=0,e,c,i,b,k=function(n,l){var m=n.get_tree_id();e=$("#search_form");c=$("#search_input");h=$(".breadcrumb_search");i=h.find(".search_button");g=h.height();b=n.get_breadcrumbs();i.toggle(function(){if(!i.hasClass("disabled")){f()}},function(){if(!i.hasClass("disabled")){j()}}).tipsy({fade:true,gravity:"s"});e.live("submit",function(q){var t=n.get_current_crumb(),p=b[t]["url"],s=s||0,r={},o=l.children(".has_content");q.preventDefault();if(b[t]["searchable"]){if($(this).serialize()!=="search="){$.bbq.pushState($(this).serialize())}p+="?offset="+s;o.html("<img src='images/spinner.gif' >");$(this).ajaxSubmit({url:p,data:r,cache:false,success:function(v){var u=v.html?v.html:v;o.html(u);$(document).trigger("search_complete.slidingtree")},error:function(u){}})}});$(document).bind("hashchange."+m,function(o,p){a(p)});a(n.get_current_crumb())},a=function(m){var l=b[m]["searchable"];$.bbq.removeState("search");d(l)},d=function(l){j();if(!l){i.css({backgroundPosition:"0 0"});i.addClass("disabled");i.attr("title",i18n.disabled_search)}else{i.css({backgroundPosition:"0 -16px"});i.removeClass("disabled");i.attr("title",i18n.search)}},f=function(){h.animate({height:g+40},{duration:200,queue:false});c.css("margin-left","4px");e.css("opacity","0").show();e.animate({opacity:"1"},{duration:200,queue:false});c.animate({width:(h.width()-60)+"px",opacity:"1"},{duration:200,queue:false});i.css({backgroundPosition:"-32px -16px"});i.attr("title",i18n.close)},j=function(){e.fadeOut("fast",function(){h.animate({height:g},"fast")});i.css({backgroundPosition:"0 -16px"});i.attr("title",i18n.search)};return{init:k,open:f,close:j}};sliding_tree.ActionBar=function(e){var f=undefined,e=e||{},a=function(j,i){var i=i||{};i.animate_time=500;if(f!==j&&f!==undefined){i.opening=false;e[f].setup_fn(i);$("#"+e[f].container).slideToggle(i.animate_time,function(){f=j;i.opening=true;h(i,j)})}else{if(f!==undefined){f=undefined;i.opening=false;h(i,j)}else{f=j;i.opening=true;h(i,j)}}},h=function(i,k){var j=$("#"+e[k].container);i=e[k].setup_fn(i);j.slideToggle(i.animate_time,i.after_function)},g=function(){if(f){a(f,{opening:false})}},d=function(){g()},b=function(j,i){if(e[j]!==undefined){delete e[j]}e[j]=i;c(j,i)},c=function(j,i){$("#"+i.button).unbind("click").click(function(){if($(this).hasClass("disabled")){return false}a(j,i.options)});$("#"+i.button).unbind("keypress").keypress(function(k){k.preventDefault();if($(this).hasClass("disabled")){return false}if(k.which===13){a(j,i.options)}})};for(item in e){c(item,e[item])}return{toggle:a,close:g,reset:d,add_to_toggle_list:b}};KT.roles={};KT.roles.permissionWidget=function(){var i=undefined,k="create",h=$("#next_button"),m=$("#previous_button"),v=$("#save_permission_button"),o=$("#all_types"),r=$("#all_verbs"),n=$("#all_tags"),w=KT.roles.permissionWidget.progressBar,d={resource_type:{previous:false,next:{stage:"verbs",actions:function(){if(o.hasClass("selected")){d.verbs.container.hide();d.details.container.show();i="details";w.setProgress(50);v.show();h.hide()}else{w.setProgress(50)}m.show()}},container:$("#resource_type_container"),input:$("#resource_type"),validate:function(){return true}},verbs:{previous:{stage:"resource_type",actions:function(){w.setProgress(25);m.hide();h.show()}},next:{stage:"tags",actions:function(){if(roleActions.getCurrentOrganization()==="global"){d.tags.container.hide();i="details";d[i].container.show();h.hide();v.show();m.show();w.setProgress(100)}else{if($("#resource_type").val()==="organizations"){d.tags.container.hide();i="details";d[i].container.show();h.hide();v.show();m.show();w.setProgress(100)}else{w.setProgress(75);v.hide();h.show();m.show()}}}},container:$("#verbs_container"),input:$("#verbs"),validate:function(){if($("#verbs").val()===null&&!r.hasClass("selected")){if(!$("#verbs_container").find("span").hasClass("validation_error")){$("#verbs_container").append('<div class="permission_widget_container"><span class="validation_error">'+i18n.verb_validation+"</span></div>")}return false}else{$(".validation_error").parent().remove();return true}}},tags:{previous:{stage:"verbs",actions:function(){w.setProgress(50);h.show()}},next:{stage:"details",actions:function(){w.setProgress(100);v.show();h.hide();m.show();d.details.input.focus()}},container:$("#tags_container"),input:$("#tags"),validate:function(){return true}},details:{previous:{stage:"tags",actions:function(){if(o.hasClass("selected")){i="resource_type";d.details.container.hide();v.hide();h.show();m.hide();w.setProgress(25)}else{if(roleActions.getCurrentOrganization()==="global"){i="verbs";v.hide();h.show();m.show();w.setProgress(50);d.details.container.hide()}else{if($("#resource_type").val()==="organizations"){i="verbs";v.hide();h.show();m.show();w.setProgress(50);d.details.container.hide()}else{w.setProgress(75);m.show();h.show();v.hide()}}}}},next:false,container:$("#details_container"),input:$("#permission_name"),validate:function(){if($("#permission_name").val()===""){if(!$("#name_container").find("span").hasClass("validation_error")){$("#name_container").append('<span class="validation_error">'+i18n.name_validation+"</span>");$("#permission_name").addClass("input_error")}return false}else{$("#details_container").find("span").remove();$("#permission_name").removeClass("input_error");return true}}}},q=function(){h.unbind("click").click(c);$("#permission_widget").find("input").unbind("keypress").keypress(s);$("#permission_widget").find("select").unbind("keypress").keypress(s);m.unbind("click").click(j);v.unbind("click").click(b);o.unbind("click").click(function(){f()});r.unbind("click").click(function(){l()});n.unbind("click").click(function(){a()})},u=function(){var x;f(true);i="resource_type";for(x in d){if(d.hasOwnProperty(x)&&x!==i){d[x].container.hide()}}w.setProgress(25);r.removeClass("selected");r.html(i18n.all);n.removeClass("selected");n.html(i18n.all);v.removeClass("disabled");h.show();v.hide();m.hide();d.verbs.input.removeAttr("disabled");d.tags.input.removeAttr("disabled");$("#add_permission_form")[0].reset();$(".validation_error").remove()},s=function(x){if(x.which===13){x.preventDefault();if(i==="details"&&$("#description").is(":focus")){b()}else{c()}}},c=function(){var x=d[i].next.stage,y=i;if(d[y].validate()){i=x;d[x].container.show();d[y].next.actions()}},j=function(){var x=d[i].previous.stage,y=i;i=x;d[y].container.hide();d[y].previous.actions()},b=function(){if(v.hasClass("disabled")){return false}v.addClass("disabled");roleActions.savePermission(k,function(){u();v.removeClass("disabled")},function(){v.removeClass("disabled")})},t=function(A){var y=roles_breadcrumb[A].permission_details,z=d.resource_type.input,x="";z.empty();for(type in y){if(y.hasOwnProperty(type)){if(type!=="all"){if(A.split("_")[0]==="organization"){if(!y[type].global){x+='<option value="'+type+'">'+y[type].name+"</option>"}}else{x+='<option value="'+type+'">'+y[type].name+"</option>"}}else{x+='<option class="hidden" value="all">All</option>'}}}z.append(x)},p=function(B,E){var z,y=0,D=d.verbs.input,C=d.tags.input,x=roles_breadcrumb[E].permission_details[B].verbs,F=roles_breadcrumb[E].permission_details[B].tags,A="";y=x.length;D.empty();for(z=0;z<y;z+=1){A+='<option value="'+x[z].name+'">'+x[z].display_name+"</option>"}D.append(A);A="";d.tags.container.find(".info_text").remove();if(B!=="organizations"&&E!=="global"){y=F.length;C.empty();for(z=0;z<y;z+=1){A+='<option value="'+F[z].name+'">'+F[z].display_name+"</option>"}C.append(A);C.show();n.show()}},g=function(y){var x=y.opening,A=roleActions.getCurrentOrganization(),z=$("#add_permission");k="create";if(x){u();t(A);p(d.resource_type.input.val(),A);z.children("span").html(i18n.close_add_permission);z.addClass("highlighted");d.resource_type.input.unbind("change").change(function(B){p(B.currentTarget.value,A);if(i!=="resource_type"){i="verbs";d.tags.container.hide();d.details.container.hide();h.show();v.hide();w.setProgress(50)}if(r.hasClass("selected")){l()}if(n.hasClass("selected")){a()}});if(A==="global"){$("#permission_widget_header").html(i18n.add_header_global)}else{$("#permission_widget_header").html(i18n.add_header_org+" "+roles_breadcrumb[A].name)}$("#permission_widget_header").addClass("one-line-ellipsis")}else{z.children("span").html(i18n.add_permission);z.removeClass("highlighted")}return y},e=function(A){var y=roles_breadcrumb[KT.roles.tree.get_current_crumb()],x=A.opening,E=roleActions.getCurrentOrganization(),C=$("#edit_permission"),B=0,D=0,z=[];k="update";if(x){u();C.children("span").html(i18n.close_edit_permission);C.addClass("highlighted");t(E);for(item in d){d[item].container.show()}d.resource_type.input.val(y.type);d.details.input.val(y.name);$("#description").val(y.description);d.resource_type.input.unbind("change").change(function(F){p(F.currentTarget.value,E);if(d.resource_type.input.val()!=="organizations"&&E!=="global"){d.tags.container.show()}else{d.tags.container.hide()}if(F.currentTarget.value==="all"){f()}if(r.hasClass("selected")){l()}if(n.hasClass("selected")){a()}}).change();if(y.tags==="all"){a(false)}else{if(E!=="global"){D=y.tags.length;z=[];for(B=0;B<D;B+=1){z.push(y.tags[B].name);d.verbs.input.find("option[value="+y.tags[B].name+"]").attr("selected",true)}d.tags.input.val(z)}}if(y.verbs==="all"){l(false)}else{D=y.verbs.length;for(B=0;B<D;B+=1){z.push(y.verbs[B].name);d.verbs.input.find("option[value="+y.verbs[B].name+"]").attr("selected",true)}d.verbs.input.val(z)}if(y.type==="all"){d.tags.container.hide();d.verbs.container.hide()}if(roleActions.getCurrentOrganization()==="global"){d.tags.container.hide()}i="details";h.hide();v.show();m.hide();w.setProgress(100);$("#permission_widget_header").html(i18n.edit_permission_header+" "+roles_breadcrumb[E].name+" - "+y.name);$("#permission_widget_header").addClass("one-line-ellipsis")}else{C.children("span").html(i18n.edit_permission);C.removeClass("highlighted")}return A},f=function(x){x=x||o.hasClass("selected");if(!x){d.resource_type.input.hide();d.resource_type.input.val("all");$("#all_types_span").hide();$('<span id="all_types_selected" class="grid_5">'+i18n.all_types_selected+"</span>").insertBefore(o);o.html(i18n.cancel);o.addClass("selected");d.verbs.container.hide();d.tags.container.hide();m.hide();if(k==="create"){i="resource_type";$("#all_types_span").hide();d.details.container.hide();w.setProgress(25);v.hide();h.show()}}else{$("#all_types_span").show();d.resource_type.input.show();$("#all_types_selected").remove();o.html(i18n.all);o.removeClass("selected");d.verbs.container.show();d.tags.container.show();d.resource_type.input.val("organizations").change();if(k==="create"){d.tags.container.hide();d.details.container.hide();d.verbs.container.hide();i="resource_type";h.show();v.hide();m.hide()}}},l=function(x){x=x||r.hasClass("selected");if(!x){d.verbs.input.attr("disabled","disabled");r.html(i18n.cancel);r.addClass("selected")}else{d.verbs.input.removeAttr("disabled");r.html(i18n.all);r.removeClass("selected")}},a=function(x){x=x||n.hasClass("selected");if(!x){d.tags.input.attr("disabled","disabled");n.html(i18n.cancel);n.addClass("selected")}else{d.tags.input.removeAttr("disabled");n.html(i18n.all);n.removeClass("selected")}};return{add_permission:g,edit_permission:e,init:q}};KT.roles.permissionWidget.progressBar=(function(b){var c=function(e){var d=b("#progressbar");d.progressbar({value:e})},a=function(e){var d=b("#progressbar");d.progressbar({value:e})};return{init:c,setProgress:a}})(jQuery);var roleActions=(function($){var current_crumb=undefined,current_organization=undefined,role_edit=function(options){var name_box=$(".edit_name_text"),edit_button=$("#edit_role > span"),description=$(".edit_description"),after_function=undefined,nameBreadcrumb=$(".tree_breadcrumb"),opening=options.opening,setup_edit=function(){var url=KT.routes.role_path($("#role_id").val()),name_box=$(".edit_name_text"),description=$(".edit_description"),common={method:"PUT",cancel:i18n.cancel,submit:i18n.save,indicator:i18n.saving,tooltip:i18n.clickToEdit,placeholder:i18n.clickToEdit,submitdata:$.extend({authenticity_token:AUTH_TOKEN},KT.common.getSearchParams()),onerror:function(settings,original,xhr){original.reset()}};name_box.each(function(){var settings={type:"text",width:270,name:$(this).attr("name"),onsuccess:function(data){var parsed=$.parseJSON(data);roles_breadcrumb.roles.name=parsed.name;$("#list #role_"+$("#role_id").val()+" .column_1").html(parsed.name);$(".edit_name_text").html(parsed.name);$("#roles").html(parsed.name+" \u2002\u00BB\u2002");notices.checkNotices()}};$(this).editable(url,$.extend(settings,common))});description.each(function(){var settings={type:"textarea",name:$(this).attr("name"),rows:5,cols:30,onsuccess:function(data){var parsed=$.parseJSON(data);$(".edit_description").html(parsed.description);notices.checkNotices()}};$(this).editable(url,$.extend(settings,common))})};if(opening){edit_button.html(i18n.close_role_details);edit_button.parent().addClass("highlighted");options.after_function=setup_edit}else{edit_button.html(i18n.edit_role_details);edit_button.parent().removeClass("highlighted")}return options},setCurrentCrumb=function(hash_id){current_crumb=hash_id},getCurrentOrganization=function(){return current_organization},setCurrentOrganization=function(hash_id){var split=hash_id.split("_");if(split[0]==="organization"||split[0]==="global"){current_organization=hash_id;getPermissionDetails()}else{if(split[1]==="global"){current_organization="global";getPermissionDetails()}else{if(split[0]==="permission"){current_organization="organization_"+split[1];getPermissionDetails()}else{current_organization=hash_id}}}},getPermissionDetails=function(){var id=current_organization.split("_")[1];if(!roles_breadcrumb[current_organization].permission_details&&current_organization!==""&&current_organization!==undefined){$("#add_permission").addClass("disabled");$.ajax({type:"GET",url:KT.common.rootURL()+"roles/"+id+"/resource_type/verbs_and_scopes",cache:false,dataType:"json",success:function(data){if(roles_breadcrumb[current_organization]){roles_breadcrumb[current_organization].permission_details=data}$("#add_permission").removeClass("disabled")}})}},savePermission=function(mode,successCallback,errorCallback){var org_id=current_crumb.split("_")[1],form=$("#add_permission_form"),to_submit=form;if(current_organization!=="global"){to_submit.find("#organization_id").val(org_id)}if($("#all_verbs").hasClass("selected")){to_submit=to_submit.serializeArray();to_submit.push({name:"permission[all_verbs]",value:true})}if($("#all_tags").hasClass("selected")){if(!(to_submit instanceof Array)){to_submit=to_submit.serializeArray()}to_submit.push({name:"permission[all_tags]",value:true})}if(to_submit instanceof Array){to_submit=$.param(to_submit)}else{to_submit=to_submit.serialize()}if(mode==="create"){$.ajax({type:"PUT",url:$("#save_permission_button").attr("data-url"),cache:false,data:to_submit,dataType:"json",success:function(data){$.extend(roles_breadcrumb,data);KT.roles.tree.rerender_content();form[0].reset();roles_breadcrumb[current_organization].count+=1;if(data.type==="all"){roles_breadcrumb[current_organization].full_access=true}successCallback()},error:function(){errorCallback()}})}else{if(mode==="update"){$.ajax({type:"POST",url:KT.common.rootURL()+"roles/"+$("#role_id").val()+"/permission/"+current_crumb.split("_")[2]+"/update_permission/",cache:false,data:to_submit,dataType:"json",success:function(data){roles_breadcrumb[current_crumb]=data[current_crumb];KT.roles.tree.rerender_content();KT.roles.tree.rerender_breadcrumb();form[0].reset();if(data.type==="all"){roles_breadcrumb[current_organization].full_access=true}successCallback()},error:function(){errorCallback()}})}}},remove_permission=function(element){var id=element.attr("data-id");element.html(i18n.removing);$.ajax({type:"DELETE",url:KT.common.rootURL()+"roles/"+$("#role_id").val()+"/permission/"+id.split("_")[2]+"/destroy_permission/",cache:false,dataType:"json",success:function(data){if(roles_breadcrumb[id].type==="all"){delete roles_breadcrumb[id];roles_breadcrumb[current_organization].full_access=false;for(item in roles_breadcrumb){if(roles_breadcrumb.hasOwnProperty(item)){if(item.split("_")[0]==="permission"&&item.split("_")[1]===id.split("_")[1]&&roles_breadcrumb[item].type==="all"){roles_breadcrumb[current_organization].full_access=true}}}}else{delete roles_breadcrumb[id]}roles_breadcrumb[current_organization].count-=1;KT.roles.tree.rerender_content()},error:function(){element.removeClass("disabled")}})},edit_user=function(element,adding){var submit_data={update_users:{adding:adding,user_id:element.attr("data-id").split("_")[1]}};if(adding){element.html(i18n.adding)}else{element.html(i18n.removing)}$.ajax({type:"PUT",url:KT.common.rootURL()+"roles/"+$("#role_id").val(),cache:false,data:$.param(submit_data),dataType:"json",success:function(data){if(adding){roles_breadcrumb[element.attr("data-id")].has_role=true}else{roles_breadcrumb[element.attr("data-id")].has_role=false}KT.roles.tree.rerender_content()},error:function(){element.removeClass("disabled")}})},handleContentAddRemove=function(element){element.addClass("disabled");if(element.attr("data-type")==="permission"){if(element.hasClass("remove_permission")){remove_permission(element)}}else{if(element.attr("data-type")==="user"){if(element.hasClass("add_user")){edit_user(element,true)}else{if(element.hasClass("remove_user")){edit_user(element,false)}}}}},removeRole=function(button){button.addClass("disabled");$.ajax({type:"DELETE",url:button.attr("data-url"),cache:false,success:function(data){eval(data)}})};return{getPermissionDetails:getPermissionDetails,setCurrentCrumb:setCurrentCrumb,savePermission:savePermission,handleContentAddRemove:handleContentAddRemove,setCurrentOrganization:setCurrentOrganization,getCurrentOrganization:getCurrentOrganization,removeRole:removeRole,role_edit:role_edit}})(jQuery);var templateLibrary=(function(b){var a=function(p,l,o,n,k){var m="";if(k){m+='<li class="no_slide"><div id="'+p+'">'}else{m+='<li class="slide_link"><div class="simple_link link_details" id="'+p+'">'}m+='<span class="sort_attr">'+l;if(n!==undefined&&n!==null&&n!==false){m+=" ("+n+") "}if(o!==undefined&&o!==null&&o!==false){m+=" ("+o+")"}m+="</span></div></li>";return m},g=function(k,n,l){var m='<ul class="filterable">',l=l?l:{};for(item in k){if(k.hasOwnProperty(item)){if(item.split("_")[0]===n){m+=a(item,k[item].name,false,false,l.no_slide)}}}m+="</ul>";return m},h=function(k,n,l){var m='<ul class="filterable">',l=l?l:{},o=false;m+=a("global",k.global.name,k.global.count,false);for(item in k){if(k.hasOwnProperty(item)){if(item.split("_")[0]===n){o=k[item].full_access?i18n.full_access:false;m+=a(item,k[item].name,k[item].count,o,l.no_slide)}}}m+="</ul>";return m},c=function(m,o,k){var l='<ul class="filterable">',n=0;for(item in m){if(m.hasOwnProperty(item)){if(item.split("_")[0]==="permission"&&m[item].organization==="organization_"+o){l+=f(item,m[item].name,k.show_button);n+=1}}}if(n===0){l+='<li class="no_slide no_hover">'+i18n.no_permissions+"</li>"}l+="</ul>";return l},f=function(n,m,k){var l="";if(k){l='<a class="fr content_add_remove remove_permission st_button"data-type="permission" data-id="'+n+'">';l+=i18n.remove+"</a>"}return'<li class="slide_link">'+l+'<div class="simple_link link_details" id="'+n+'"><span class="sort_attr">'+m+"</span></div></li>"},j=function(k){var m=0,n=0,l='<div class="permission_detail">';l+='<div class="permission_detail_container"><label class="grid_3 ra">Name: </label><span>'+k.name+"</span></div>";l+='<div class="permission_detail_container"><label class="grid_3 ra">Description: </label><span>'+k.description+"</span></div>";l+='<div class="permission_detail_container"><label class="grid_3 ra">Permission For: </label><span>'+k.type_name+"</span></div>";l+='<div class="permission_detail_container"><label class="grid_3 ra">Verb(s): </label><ul>';if(k.verbs==="all"){l+="<li>All</li>"}else{n=k.verbs.length;for(m=0;m<n;m+=1){l+="<li>"+k.verbs[m].display_name+"</li>"}}l+="</ul></div>";l+='<div class="permission_detail_container"><label class="grid_3 ra">On:</label><ul>';if(k.tags==="all"){l+="<li>All</li>"}else{n=k.tags.length;for(m=0;m<n;m+=1){l+="<li>"+k.tags[m].display_name+"</li>"}}l+="</ul></div></div>";return l},d=function(l,o,q,n,k){var m="",p=n?'<li class="no_slide">':'<li class="slide_link">';if(k){m='<a class="fr content_add_remove ';m+=q?"remove_user":"add_user";m+=' st_button" data-type="user" data-id="'+l+'">';m+=q?(i18n.remove+"</a>"):(i18n.add+"</a>")}else{m='<div class="fr st_button">';m+=q?(i18n.rule_applied+"</div>"):(i18n.rule_not_applied+"</div>")}p+=m+'<div class="simple_link ';p+=n?"":"link_details";p+='"><span class="sort_attr">'+o+"</span></div></li>";return p},i=function(n,l){var m='<ul class="filterable">',k=undefined;for(item in n){if(n.hasOwnProperty(item)){k=item.split("_");if(k[0]==="user"){m+=d(item,n[item].name,n[item].has_role,l.no_slide,l.show_button)}}}m+="</ul>";return m},e=function(n,k){var l='<ul class="filterable">',m=0;for(item in n){if(n.hasOwnProperty(item)){if(item.split("_")[0]==="permission"&&item.split("_")[1]==="global"){l+=f(item,n[item].name,k.show_button);m+=1}}}if(m===0){l+='<li class="no_slide no_hover">'+i18n.no_global_permissions+"</li>"}l+="</ul>";return l};return{list:g,organizationsList:h,permissionsList:c,usersList:i,globalsList:e,permissionItem:j}}(jQuery));var rolesRenderer=(function(f){var b=function(o,j){var k={};if(o==="role_permissions"){j(templateLibrary.organizationsList(roles_breadcrumb,"organization"))}else{if(o==="roles"){j(templateLibrary.list(roles_breadcrumb,"role"))}else{if(o==="role_users"){if(permissions.create_roles||permissions.update_roles){k.show_button=true}k.no_slide=true;j(templateLibrary.usersList(roles_breadcrumb,k))}else{if(o==="global"){if((!roles_breadcrumb.roles.locked)&&(permissions.create_roles||permissions.update_roles)){k.show_button=true}k.no_slide=false;j(templateLibrary.globalsList(roles_breadcrumb,k))}else{var l=o.split("_"),n=l[0],m=l[1];j(d(n,o,m))}}}}},d=function(k,m,l){var j={};if(k==="organization"){if((!roles_breadcrumb.roles.locked)&&(permissions.create_roles||permissions.update_roles)){j.show_button=true}return templateLibrary.permissionsList(roles_breadcrumb,l,j)}else{if(k==="permission"){return templateLibrary.permissionItem(roles_breadcrumb[m])}}},g=function(j){f(".will_have_content").find("li").sortElements(function(l,k){var n=f(l).find(".sort_attr").html();var m=f(k).find(".sort_attr").html();if(n&&m){return n.toUpperCase()>m.toUpperCase()?1:-1}});if(j==="role_permissions"){f("#global").parent().prependTo(f(".will_have_content ul"))}},h=function(){var j=f(".left").height(),k=f("#panel_main");k.find(".sliding_list").css({height:j-60});k.find(".slider").css({height:j-60});k.height(j);k.find(".jspPage").height(j)},c=function(){var j=f(".panel-custom"),k=j.width();j.find(".sliding_container").width(k);j.find(".breadcrumb_filter").width(k);j.find(".slider").width(k);j.find(".sliding_list").width(k*2);j.find(".slide_up_container").width(k)},i=function(){var j=f(".left");j.resize(function(){c()});j.trigger("resize")},e=function(k){var j=f("#roles_status");if(k==="roles"){if(permissions.create_roles||permissions.update_roles){j.html(i18n.roles_summary)}else{j.html(i18n.roles_summary_readonly)}}else{if(k==="role_users"){if(permissions.create_roles||permissions.update_roles){j.html(i18n.users_summary)}else{j.html(i18n.users_summary_readonly)}}else{if(k==="role_permissions"){if(permissions.create_roles||permissions.update_roles){j.html(i18n.role_permissions_summary)}else{j.html(i18n.role_permissions_summary_readonly)}}else{if(k==="global"||k.match(/organization?/g)){if(permissions.create_roles||permissions.update_roles){j.html(i18n.permissions_summary)}else{j.html(i18n.permissions_summary_readonly)}}else{if(k.match(/permission?/g)){if(permissions.create_roles||permissions.update_roles){j.html(i18n.permission_detail_summary)}else{j.html(i18n.permission_detail_readonly)}}}}}}},a=function(m){var k=m.split("_")[0],l=f("#add_permission"),j=f("#edit_permission");if(k==="organization"||k==="permission"||k==="global"){l.removeClass("disabled");roleActions.setCurrentOrganization(m)}else{l.addClass("disabled");roleActions.setCurrentOrganization("")}if(k==="permission"){j.removeClass("disabled")}else{if(!j.hasClass("disabled")){j.addClass("disabled")}}};return{init:i,render:b,sort:g,setTreeHeight:h,setSummary:e,handleButtons:a}}(jQuery));var pageActions=(function(c){var b={role_edit:{container:"role_edit",button:"edit_role",setup_fn:roleActions.role_edit}},a=function(){var d=KT.roles.actionBar;c(".content_add_remove").live("click",function(){if(c(this).hasClass("disabled")){return false}roleActions.handleContentAddRemove(c(this))});c("#remove_role").live("click",function(){var e=c(this);KT.common.customConfirm(e.attr("data-confirm-text"),function(){roleActions.removeRole(e)})});c("#remove_role").live("keypress",function(f){var e=c(this);f.preventDefault();if(f.which===13){KT.common.customConfirm(e.attr("data-confirm-text"),function(){roleActions.removeRole(e)})}});KT.panel.set_contract_cb(function(e){c.bbq.removeState("role_edit");c("#panel").removeClass("panel-custom");d.reset()});KT.panel.set_switch_content_cb(function(){c.bbq.removeState("role_edit");c("#panel").removeClass("panel-custom");d.reset()})};return{registerEvents:a,toggle_list:b}})(jQuery);$(document).ready(function(){KT.roles.actionBar=sliding_tree.ActionBar();pageActions.registerEvents();$(".left").resizable("destroy")});